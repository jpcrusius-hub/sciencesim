<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decoder - Quiz Elektrik</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #9c27b0, #7b1fa2); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .header h1 { font-size: 1.5em; }
        .scan-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .scan-section h2 { margin-bottom: 15px; color: #333; }
        .camera-controls { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .camera-controls select { padding: 10px 15px; font-size: 1em; border: 2px solid #ddd; border-radius: 8px; flex: 1; min-width: 200px; }
        .camera-controls button { padding: 10px 20px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer; }
        .btn-start { background: #4CAF50; color: white; }
        .btn-stop { background: #f44336; color: white; }
        #reader { width: 100%; max-width: 500px; margin: 0 auto; }
        .manual-input { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .manual-input textarea { width: 100%; height: 100px; padding: 10px; font-family: monospace; font-size: 0.9em; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        .manual-input button { padding: 10px 30px; font-size: 1em; background: #2196F3; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .results-section { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .results-section h2 { margin-bottom: 15px; }
        .class-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px; }
        .seat-card { padding: 15px 10px; border: 2px solid #ddd; border-radius: 8px; text-align: center; background: white; cursor: pointer; transition: all 0.2s; }
        .seat-card:hover { transform: scale(1.02); }
        .seat-card.scanned { border-color: #4CAF50; background: #e8f5e9; }
        .seat-card .seat-id { font-weight: bold; font-size: 1.1em; }
        .seat-card .seat-niveau { font-size: 0.8em; color: #666; }
        .seat-card .seat-grade { font-size: 1.3em; font-weight: bold; margin: 5px 0; }
        .seat-card .seat-points { font-size: 0.9em; color: #666; }
        .seat-card.grade-1 .seat-grade { color: #4CAF50; }
        .seat-card.grade-2 .seat-grade { color: #8BC34A; }
        .seat-card.grade-3 .seat-grade { color: #FFC107; }
        .seat-card.grade-4 .seat-grade { color: #FF9800; }
        .seat-card.grade-5 .seat-grade { color: #f44336; }
        .seat-card.grade-6 .seat-grade { color: #9E9E9E; }
        .export-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .export-section button { padding: 12px 30px; font-size: 1em; background: #9c27b0; color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px; }
        .detail-view { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 20px; }
        .detail-view.active { display: flex; }
        .detail-content { background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; }
        .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .detail-header h3 { font-size: 1.3em; }
        .close-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999; }
        .detail-grade { text-align: center; padding: 20px; background: #e8f5e9; border-radius: 8px; margin-bottom: 20px; }
        .detail-grade.bad { background: #ffebee; }
        .detail-grade.medium { background: #fff3e0; }
        .detail-np { font-size: 3em; font-weight: bold; }
        .detail-item { padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 3px solid #ddd; }
        .detail-item.correct { background: #e8f5e9; border-left-color: #4CAF50; }
        .detail-item.incorrect { background: #ffebee; border-left-color: #f44336; }
        .detail-item.partial { background: #fff3e0; border-left-color: #ff9800; }
        .detail-item.not-graded { background: #f5f5f5; border-left-color: #9e9e9e; opacity: 0.6; }
        .stats-bar { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-item { padding: 15px 25px; background: #e3f2fd; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; color: #1976D2; }
        .stat-label { font-size: 0.9em; color: #666; }
        .niveau-filter { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .niveau-filter button { padding: 8px 16px; border: 2px solid #ddd; border-radius: 8px; background: white; cursor: pointer; }
        .niveau-filter button.active { border-color: #9c27b0; background: #f3e5f5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Decoder - Quiz Elektrik</h1>
            <p>Stromst√§rke & Spannung ‚Ä¢ Klasse 8 Physik</p>
        </div>
        
        <div class="scan-section">
            <h2>üì∑ QR-Code scannen</h2>
            <div class="camera-controls">
                <select id="cameraSelect"><option value="">Kamera w√§hlen...</option></select>
                <button class="btn-start" id="startBtn">Scanner starten</button>
                <button class="btn-stop" id="stopBtn" style="display:none;">Scanner stoppen</button>
            </div>
            <div id="reader"></div>
            <div class="manual-input">
                <h3>Oder Code manuell eingeben:</h3>
                <textarea id="manualCode" placeholder="Code hier einf√ºgen..."></textarea>
                <button id="decodeBtn">Dekodieren</button>
            </div>
        </div>
        
        <div class="results-section">
            <h2>üìä Klassen√ºbersicht</h2>
            <div class="stats-bar">
                <div class="stat-item"><div class="stat-value" id="statScanned">0</div><div class="stat-label">Gescannt</div></div>
                <div class="stat-item"><div class="stat-value" id="statAvg">--</div><div class="stat-label">√ò Punkte</div></div>
                <div class="stat-item"><div class="stat-value" id="statAvgGrade">--</div><div class="stat-label">√ò Note</div></div>
            </div>
            <div class="niveau-filter">
                <button class="active" data-filter="all">Alle</button>
                <button data-filter="1">‚≠ê Stern 1</button>
                <button data-filter="2">‚≠ê‚≠ê Stern 2</button>
                <button data-filter="3">‚≠ê‚≠ê‚≠ê Stern 3</button>
            </div>
            <div class="class-grid" id="classGrid"></div>
            <div class="export-section">
                <button id="exportCsv">üì• CSV exportieren</button>
                <button id="clearAll">üóëÔ∏è Alle l√∂schen</button>
            </div>
        </div>
    </div>
    
    <div class="detail-view" id="detailView">
        <div class="detail-content">
            <div class="detail-header">
                <h3 id="detailTitle">P01</h3>
                <button class="close-btn" onclick="closeDetail()">√ó</button>
            </div>
            <div class="detail-grade" id="detailGrade">
                <div class="detail-np" id="detailNP">--</div>
                <div id="detailNote">NP</div>
                <div id="detailPoints">-- / -- Punkte</div>
                <div id="detailNiveau" style="margin-top:10px;font-size:0.9em;">Niveau: --</div>
            </div>
            <div id="detailContent"></div>
        </div>
    </div>

<script>
const NIVEAU_CONFIG = {
    1: { name: 'Stern 1', stars: '‚≠ê', points: 38, maxNiveau: '*' },
    2: { name: 'Stern 2', stars: '‚≠ê‚≠ê', points: 54, maxNiveau: '**' },
    3: { name: 'Stern 3', stars: '‚≠ê‚≠ê‚≠ê', points: 65, maxNiveau: '***' }
};

const GRADE_SCALE = [
    { np: 14, percent: 100, note: '1+' }, { np: 13, percent: 96, note: '1' },
    { np: 12, percent: 91, note: '1-' }, { np: 11, percent: 86, note: '2+' },
    { np: 10, percent: 80, note: '2' }, { np: 9, percent: 73, note: '2-' },
    { np: 8, percent: 67, note: '3+' }, { np: 7, percent: 60, note: '3' },
    { np: 6, percent: 53, note: '3-' }, { np: 5, percent: 47, note: '4+' },
    { np: 4, percent: 40, note: '4' }, { np: 3, percent: 33, note: '4-' },
    { np: 2, percent: 27, note: '5+' }, { np: 1, percent: 20, note: '5' }
];

const QUESTIONS = [
    { id: 'I1', title: 'I.1 Definition Stromst√§rke', points: 5, niveau: '*' },
    { id: 'I2a', title: 'I.2a Umrechnungen', points: 3, niveau: '*' },
    { id: 'I2b', title: 'I.2b Umrechnungen', points: 3, niveau: '**' },
    { id: 'I3', title: 'I.3 Messger√§t', points: 3, niveau: '*' },
    { id: 'I4', title: 'I.4 Regel Reihe', points: 1, niveau: '*' },
    { id: 'I5', title: 'I.5 Regel Parallel', points: 1, niveau: '*' },
    { id: 'I6', title: 'I.6 Reihe 2L', points: 2, niveau: '*' },
    { id: 'I7', title: 'I.7 Parallel 2L', points: 1, niveau: '*' },
    { id: 'I8', title: 'I.8 Parallel 3L', points: 1, niveau: '*' },
    { id: 'I9', title: 'I.9 I‚ÇÇ gesucht', points: 1, niveau: '**' },
    { id: 'I10', title: 'I.10 mit mA', points: 2, niveau: '**' },
    { id: 'I11', title: 'I.11 I‚ÇÉ berechnen', points: 1, niveau: '**' },
    { id: 'I12', title: 'I.12 Gemischt', points: 2, niveau: '***' },
    { id: 'I13', title: 'I.13 Verschachtelt', points: 3, niveau: '***' },
    { id: 'II1', title: 'II.1 Definition Spannung', points: 4, niveau: '*' },
    { id: 'II2a', title: 'II.2a Umrechnungen', points: 4, niveau: '*' },
    { id: 'II2b', title: 'II.2b Umrechnungen', points: 3, niveau: '**' },
    { id: 'II2c', title: 'II.2c mit MV', points: 2, niveau: '***' },
    { id: 'II3', title: 'II.3 Spannungswerte', points: 4, niveau: '*' },
    { id: 'II4', title: 'II.4 Messger√§t', points: 3, niveau: '*' },
    { id: 'II5', title: 'II.5 Regeln', points: 2, niveau: '*' },
    { id: 'II6', title: 'II.6 Reihe 2L', points: 1, niveau: '*' },
    { id: 'II7', title: 'II.7 Parallel 2L', points: 2, niveau: '*' },
    { id: 'II8', title: 'II.8 Reihe 3L', points: 1, niveau: '*' },
    { id: 'II9', title: 'II.9 Gemischt I', points: 2, niveau: '**' },
    { id: 'II10', title: 'II.10 Zwei Reihen', points: 2, niveau: '**' },
    { id: 'II11', title: 'II.11 Gemischt II', points: 2, niveau: '**' },
    { id: 'II12', title: 'II.12 Lichterkette', points: 1, niveau: '***' },
    { id: 'II13', title: 'II.13 Profi', points: 3, niveau: '***' }
];

const CONFIG = { STORAGE_KEY: 'decoder_elektrik_unified_v5' };

let results = {};
let html5QrCode = null;
let currentCameraId = null;
let currentFilter = 'all';

document.addEventListener('DOMContentLoaded', () => {
    loadResults();
    initGrid();
    initCameras();
    initEventListeners();
    updateStats();
});

async function initCameras() {
    try {
        const cameras = await Html5Qrcode.getCameras();
        const select = document.getElementById('cameraSelect');
        select.innerHTML = '<option value="">Kamera w√§hlen...</option>';
        cameras.forEach(cam => {
            const opt = document.createElement('option');
            opt.value = cam.id;
            opt.textContent = cam.label || `Kamera ${cam.id.substring(0, 8)}...`;
            select.appendChild(opt);
        });
        if (cameras.length > 0) {
            currentCameraId = cameras[0].id;
            select.value = currentCameraId;
        }
    } catch (err) { console.error('Kamera-Fehler:', err); }
}

function initEventListeners() {
    document.getElementById('cameraSelect').addEventListener('change', (e) => { currentCameraId = e.target.value; });
    document.getElementById('startBtn').addEventListener('click', startScanner);
    document.getElementById('stopBtn').addEventListener('click', stopScanner);
    document.getElementById('decodeBtn').addEventListener('click', decodeManual);
    document.getElementById('exportCsv').addEventListener('click', exportCsv);
    document.getElementById('clearAll').addEventListener('click', clearAll);
    document.querySelectorAll('.niveau-filter button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.niveau-filter button').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            updateGrid();
        });
    });
}

async function startScanner() {
    if (!currentCameraId) { alert('Bitte w√§hle zuerst eine Kamera!'); return; }
    html5QrCode = new Html5Qrcode("reader");
    try {
        await html5QrCode.start(currentCameraId, { fps: 10, qrbox: { width: 300, height: 300 } }, onScanSuccess, () => {});
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'inline-block';
    } catch (err) { console.error('Scanner-Fehler:', err); alert('Scanner konnte nicht gestartet werden: ' + err); }
}

async function stopScanner() {
    if (html5QrCode) { try { await html5QrCode.stop(); } catch (e) {} html5QrCode = null; }
    document.getElementById('startBtn').style.display = 'inline-block';
    document.getElementById('stopBtn').style.display = 'none';
}

function onScanSuccess(decodedText) { processCode(decodedText); }

function decodeManual() {
    const code = document.getElementById('manualCode').value.trim();
    if (code) { processCode(code); document.getElementById('manualCode').value = ''; }
}

function processCode(code) {
    try {
        const json = LZString.decompressFromEncodedURIComponent(code);
        const data = JSON.parse(json);
        if (!data.s || data.p === undefined || !data.n) throw new Error('Ung√ºltiges Datenformat');
        
        const seat = data.s;
        const niveau = data.n;
        const points = data.p;
        const maxPoints = data.m || NIVEAU_CONFIG[niveau].points;
        const answers = data.a || {};
        
        results[seat] = {
            niveau: niveau,
            points: points,
            maxPoints: maxPoints,
            answers: answers,
            timestamp: Date.now(),
            grade: calculateGrade(points, maxPoints)
        };
        
        saveResults();
        updateGrid();
        updateStats();
        
        const cfg = NIVEAU_CONFIG[niveau];
        const grade = calculateGrade(points, maxPoints);
        alert(`‚úÖ ${seat} gescannt!\n${cfg.name}\n${points}/${maxPoints} Punkte\nNote: ${grade.note} (${grade.np} NP)`);
    } catch (err) { console.error('Dekodier-Fehler:', err); alert('‚ùå Ung√ºltiger Code!'); }
}

function calculateGrade(points, maxPoints) {
    const percent = (points / maxPoints) * 100;
    for (const grade of GRADE_SCALE) { if (percent >= grade.percent) return grade; }
    return { np: 0, note: '6', percent: 0 };
}

function isQuestionGraded(q, niveau) {
    const cfg = NIVEAU_CONFIG[niveau];
    if (cfg.maxNiveau === '*') return q.niveau === '*';
    if (cfg.maxNiveau === '**') return q.niveau === '*' || q.niveau === '**';
    return true;
}

function initGrid() {
    const grid = document.getElementById('classGrid');
    grid.innerHTML = '';
    for (let i = 1; i <= 30; i++) {
        const seat = 'P' + String(i).padStart(2, '0');
        const card = document.createElement('div');
        card.className = 'seat-card';
        card.id = 'card-' + seat;
        card.innerHTML = `<div class="seat-id">${seat}</div><div class="seat-niveau">--</div><div class="seat-grade">--</div><div class="seat-points">-- P</div>`;
        card.addEventListener('click', () => showDetail(seat));
        grid.appendChild(card);
    }
    updateGrid();
}

function updateGrid() {
    for (let i = 1; i <= 30; i++) {
        const seat = 'P' + String(i).padStart(2, '0');
        const card = document.getElementById('card-' + seat);
        const data = results[seat];
        
        card.className = 'seat-card';
        card.style.display = 'block';
        
        if (currentFilter !== 'all' && data && data.niveau !== parseInt(currentFilter)) {
            card.style.display = 'none';
            continue;
        }
        
        if (data) {
            card.classList.add('scanned');
            const gradeNum = Math.ceil((6 - data.grade.np / 2.5));
            card.classList.add('grade-' + Math.min(6, Math.max(1, gradeNum)));
            const cfg = NIVEAU_CONFIG[data.niveau];
            card.querySelector('.seat-niveau').textContent = cfg.stars;
            card.querySelector('.seat-grade').textContent = data.grade.note;
            card.querySelector('.seat-points').textContent = data.points + '/' + data.maxPoints + ' P';
        } else {
            card.querySelector('.seat-niveau').textContent = '--';
            card.querySelector('.seat-grade').textContent = '--';
            card.querySelector('.seat-points').textContent = '-- P';
        }
    }
}

function updateStats() {
    const entries = Object.values(results);
    const filtered = currentFilter === 'all' ? entries : entries.filter(r => r.niveau === parseInt(currentFilter));
    const scanned = filtered.length;
    document.getElementById('statScanned').textContent = scanned;
    
    if (scanned > 0) {
        const totalPercent = filtered.reduce((sum, r) => sum + (r.points / r.maxPoints) * 100, 0);
        const avgPercent = totalPercent / scanned;
        document.getElementById('statAvg').textContent = avgPercent.toFixed(0) + '%';
        const avgGrade = calculateGrade(avgPercent, 100);
        document.getElementById('statAvgGrade').textContent = avgGrade.note;
    } else {
        document.getElementById('statAvg').textContent = '--';
        document.getElementById('statAvgGrade').textContent = '--';
    }
}

function showDetail(seat) {
    const data = results[seat];
    if (!data) { alert('Noch keine Daten f√ºr ' + seat); return; }
    
    const cfg = NIVEAU_CONFIG[data.niveau];
    document.getElementById('detailTitle').textContent = seat;
    document.getElementById('detailNP').textContent = data.grade.np;
    document.getElementById('detailNote').textContent = data.grade.note;
    document.getElementById('detailPoints').textContent = `${data.points} / ${data.maxPoints} Punkte`;
    document.getElementById('detailNiveau').textContent = `Niveau: ${cfg.name} ${cfg.stars}`;
    
    const gradeEl = document.getElementById('detailGrade');
    gradeEl.className = 'detail-grade';
    if (data.grade.np < 5) gradeEl.classList.add('bad');
    else if (data.grade.np < 10) gradeEl.classList.add('medium');
    
    let detailHtml = '';
    QUESTIONS.forEach(q => {
        const graded = isQuestionGraded(q, data.niveau);
        const status = graded ? 'partial' : 'not-graded';
        detailHtml += `<div class="detail-item ${status}">${q.title} (${q.points}P) ${q.niveau} ${graded ? '' : '- nicht gewertet'}</div>`;
    });
    document.getElementById('detailContent').innerHTML = detailHtml;
    document.getElementById('detailView').classList.add('active');
}

function closeDetail() { document.getElementById('detailView').classList.remove('active'); }

function exportCsv() {
    let csv = 'Sitzplatz;Niveau;Punkte;Max;Prozent;NP;Note;Zeitstempel\n';
    for (let i = 1; i <= 30; i++) {
        const seat = 'P' + String(i).padStart(2, '0');
        const data = results[seat];
        if (data) {
            const percent = ((data.points / data.maxPoints) * 100).toFixed(1);
            const time = new Date(data.timestamp).toLocaleString('de-DE');
            const cfg = NIVEAU_CONFIG[data.niveau];
            csv += `${seat};${cfg.name};${data.points};${data.maxPoints};${percent}%;${data.grade.np};${data.grade.note};${time}\n`;
        } else {
            csv += `${seat};;;;;;;\n`;
        }
    }
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `quiz_elektrik_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function clearAll() { if (confirm('Alle Ergebnisse l√∂schen?')) { results = {}; saveResults(); updateGrid(); updateStats(); } }
function saveResults() { localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(results)); }
function loadResults() { const saved = localStorage.getItem(CONFIG.STORAGE_KEY); if (saved) { try { results = JSON.parse(saved); } catch (e) { results = {}; } } }
</script>
</body>
</html>
