<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decoder ‚Äì Bewegungslehre Quiz 10 GY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #1a1a2e; 
            color: #eee; 
            min-height: 100vh; 
            padding: 15px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; font-size: 1.3em; margin-bottom: 15px; color: #fff; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab { 
            flex: 1; 
            padding: 12px; 
            background: #252545; 
            border: none; 
            color: #aaa; 
            cursor: pointer; 
            font-size: 0.9em; 
            font-weight: 600; 
            border-radius: 6px 6px 0 0; 
            transition: all 0.2s; 
        }
        .tab:hover { background: #303060; }
        .tab.active { background: #2c5aa0; color: #fff; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card { 
            background: #252545; 
            border-radius: 8px; 
            padding: 15px; 
            margin-bottom: 15px; 
        }
        .card h2 { 
            font-size: 1em; 
            margin-bottom: 12px; 
            color: #fff; 
            padding-bottom: 8px; 
            border-bottom: 2px solid #2c5aa0; 
        }
        
        .scanner-container { 
            background: #000; 
            border-radius: 8px; 
            overflow: hidden; 
            margin-bottom: 15px; 
        }
        .camera-controls {
            background: #1a1a2e;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .camera-controls label {
            color: #aaa;
            font-size: 0.85em;
        }
        .camera-controls select {
            flex: 1;
            min-width: 200px;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #252545;
            color: #fff;
            font-size: 0.9em;
        }
        #qr-reader { 
            width: 100%; 
            max-width: 450px; 
            margin: 0 auto; 
        }
        .scanner-status { 
            padding: 15px; 
            text-align: center; 
            font-weight: 600; 
            font-size: 1.1em; 
            background: #1a1a2e; 
        }
        .scanner-status.success { color: #4caf50; }
        .scanner-status.error { color: #f44336; }
        
        .scanner-buttons { 
            display: flex; 
            gap: 10px; 
            justify-content: center; 
            padding: 12px; 
            background: #1a1a2e; 
        }
        
        button { 
            padding: 10px 18px; 
            font-size: 0.9em; 
            border: none; 
            background: #2c5aa0; 
            color: #fff; 
            cursor: pointer; 
            border-radius: 6px; 
            font-family: inherit; 
            font-weight: 500; 
            transition: background 0.2s; 
        }
        button:hover { background: #3d6bb8; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.secondary { background: #444; }
        button.secondary:hover { background: #555; }
        button.success { background: #4caf50; }
        button.danger { background: #f44336; }
        
        .manual-input { margin-top: 15px; }
        .manual-input textarea { 
            width: 100%; 
            height: 80px; 
            padding: 10px; 
            border-radius: 6px; 
            border: 1px solid #444; 
            background: #1a1a2e; 
            color: #fff; 
            font-family: monospace; 
            font-size: 0.85em; 
            resize: vertical; 
            margin-bottom: 10px; 
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .stat-card { 
            background: #1a1a2e; 
            padding: 12px; 
            border-radius: 6px; 
            text-align: center; 
        }
        .stat-card .value { 
            font-size: 1.5em; 
            font-weight: 700; 
            color: #2c5aa0; 
        }
        .stat-card .label { 
            font-size: 0.75em; 
            color: #888; 
            margin-top: 4px; 
        }
        
        .results-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.85em; 
        }
        .results-table th, .results-table td { 
            padding: 10px 8px; 
            text-align: left; 
            border-bottom: 1px solid #333; 
        }
        .results-table th { 
            background: #1a1a2e; 
            color: #aaa; 
            font-weight: 600; 
            position: sticky; 
            top: 0; 
        }
        .results-table tr:hover { background: #303050; }
        .results-table .points { font-weight: 600; }
        .results-table .good { color: #4caf50; }
        .results-table .medium { color: #ff9800; }
        .results-table .poor { color: #f44336; }
        
        .grade-badge { 
            display: inline-block; 
            padding: 3px 8px; 
            border-radius: 4px; 
            font-weight: 700; 
            font-size: 0.85em; 
        }
        .grade-badge.good { background: #4caf50; color: #fff; }
        .grade-badge.medium { background: #ff9800; color: #000; }
        .grade-badge.poor { background: #f44336; color: #fff; }
        
        .action-btn { 
            padding: 5px 10px; 
            font-size: 0.8em; 
            margin: 2px; 
        }
        
        .empty-state { 
            text-align: center; 
            padding: 40px 20px; 
            color: #666; 
        }
        .empty-state .icon { font-size: 3em; margin-bottom: 10px; }
        
        .export-section { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            justify-content: center; 
            margin-top: 15px; 
        }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.8); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
            padding: 20px; 
        }
        .modal.active { display: flex; }
        .modal-content { 
            background: #252545; 
            max-width: 600px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto; 
            border-radius: 8px; 
        }
        .modal-header { 
            padding: 15px; 
            background: #2c5aa0; 
            font-weight: 600; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .modal-header .close { 
            background: none; 
            border: none; 
            color: #fff; 
            font-size: 1.5em; 
            cursor: pointer; 
            padding: 0; 
        }
        .modal-body { padding: 20px; }
        
        .detail-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
            gap: 8px; 
            margin-bottom: 15px; 
        }
        .detail-item { 
            background: #1a1a2e; 
            padding: 10px; 
            border-radius: 6px; 
            text-align: center; 
        }
        .detail-item .label { font-size: 0.75em; color: #888; }
        .detail-item .value { font-size: 1.1em; font-weight: 600; }
        
        .question-results { margin-top: 15px; }
        .q-result { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 8px 10px; 
            background: #1a1a2e; 
            margin: 4px 0; 
            border-radius: 4px; 
            border-left: 3px solid #444; 
        }
        .q-result.correct { border-left-color: #4caf50; }
        .q-result.partial { border-left-color: #ff9800; }
        .q-result.incorrect { border-left-color: #f44336; }
        .q-result .q-id { font-weight: 600; min-width: 50px; }
        .q-result .q-points { font-weight: 600; }
        
        .scanned-indicator { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: #4caf50; 
            color: #fff; 
            padding: 10px 15px; 
            border-radius: 6px; 
            font-weight: 600; 
            z-index: 100; 
            display: none; 
        }
        .scanned-indicator.show { display: block; animation: fadeInOut 2s ease; }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; transform: translateY(-10px); } 20%, 80% { opacity: 1; transform: translateY(0); } }
        
        @media print {
            body { background: #fff; color: #000; }
            .no-print { display: none !important; }
            .card { background: #fff; border: 1px solid #000; }
            .results-table th { background: #eee; color: #000; }
            .results-table td { border-color: #ccc; }
        }
        
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
            .tabs { flex-wrap: wrap; }
            .tab { flex: 1 1 45%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîì Decoder ‚Äì Bewegungslehre 10 GY</h1>
        
        <div class="tabs no-print">
            <button class="tab active" onclick="showTab('scan')">üì∑ Scannen</button>
            <button class="tab" onclick="showTab('results')">üìä Ergebnisse</button>
            <button class="tab" onclick="showTab('export')">üì§ Export</button>
        </div>
        
        <div id="scanTab" class="tab-content active">
            <div class="card">
                <h2>üì∑ QR-Code Scanner</h2>
                <div class="scanner-container">
                    <div class="camera-controls">
                        <label>üì∑ Kamera:</label>
                        <select id="cameraSelect" onchange="switchCamera()">
                            <option value="">Wird geladen...</option>
                        </select>
                    </div>
                    <div id="qr-reader"></div>
                    <div class="scanner-status" id="scannerStatus">Kamera wird gestartet...</div>
                    <div class="scanner-buttons">
                        <button id="scannerToggleBtn" onclick="toggleScanner()">‚è∏Ô∏è Pause</button>
                        <span id="scannedCount" style="color:#4caf50; font-weight:600;">‚úÖ 0 gescannt</span>
                    </div>
                </div>
                
                <div class="manual-input">
                    <h3 style="font-size:0.9em; margin-bottom:8px; color:#aaa;">üìù Manuelle Eingabe</h3>
                    <textarea id="manualCode" placeholder="QR-Code-Text hier einf√ºgen..."></textarea>
                    <button onclick="processManualCode()">üîì Dekodieren</button>
                </div>
            </div>
        </div>
        
        <div id="resultsTab" class="tab-content">
            <div class="card">
                <h2>üìä Statistik</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card"><div class="value" id="statCount">0</div><div class="label">Gescannt</div></div>
                    <div class="stat-card"><div class="value" id="statAvgPoints">--</div><div class="label">√ò Punkte</div></div>
                    <div class="stat-card"><div class="value" id="statAvgGrade">--</div><div class="label">√ò Note</div></div>
                    <div class="stat-card"><div class="value" id="statBest">--</div><div class="label">Beste</div></div>
                    <div class="stat-card"><div class="value" id="statWorst">--</div><div class="label">Schw√§chste</div></div>
                    <div class="stat-card"><div class="value" id="statBonus">--</div><div class="label">√ò Bonus</div></div>
                </div>
            </div>
            
            <div class="card">
                <h2>üìã Ergebnisliste</h2>
                <div id="resultsContainer">
                    <div class="empty-state">
                        <div class="icon">üì∑</div>
                        <p>Noch keine Ergebnisse gescannt.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="exportTab" class="tab-content">
            <div class="card">
                <h2>üì§ Export-Optionen</h2>
                <div class="export-section">
                    <button onclick="exportCSV()">üìä CSV exportieren</button>
                    <button onclick="printAllFeedback()">üñ®Ô∏è Alle Feedbackb√∂gen</button>
                    <button class="danger" onclick="clearAllResults()">üóëÔ∏è Alle l√∂schen</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="scanned-indicator" id="scannedIndicator">‚úÖ Gescannt!</div>
    
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalTitle">Details</span>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

<script>
const CONFIG = {
    VERSION: 5.2,
    TOTAL_POINTS: 88,
    BONUS_POINTS: 3
};

const QUESTIONS = [
    { id: 'F1', text: 'MC: v=const ‚Üí s~t', type: 'mc', points: 2 },
    { id: 'F2', text: 'MC: Einheit a', type: 'mc', points: 2 },
    { id: 'F3', text: 'MC: Anstieg s(t)', type: 'mc', points: 2 },
    { id: 'F4', text: 'MC: Anstieg v(t)', type: 'mc', points: 2 },
    { id: 'F5', text: 'MC: Fl√§che v(t)', type: 'mc', points: 2 },
    { id: 'F6', text: 'MC: Fl√§che a(t)', type: 'mc', points: 2 },
    { id: 'F7', text: 'MC: Waagerecht v(t)', type: 'mc', points: 2 },
    { id: 'F8', text: 'MC: Parabel s(t)', type: 'mc', points: 2 },
    { id: 'F9', text: 'MC: Gerade v(t)', type: 'mc', points: 2 },
    { id: 'F10', text: 'MC: Neg. Fl√§che', type: 'mc', points: 2 },
    { id: 'F11', text: 'Calc: km/h‚Üím/s', type: 'calc', points: 2 },
    { id: 'F12', text: 'Calc: s=v¬∑t', type: 'calc', points: 2 },
    { id: 'F13', text: 'Calc: v=a¬∑t', type: 'calc', points: 2 },
    { id: 'F14', text: 'Calc: s=¬Ωat¬≤', type: 'calc', points: 2 },
    { id: 'F15', text: 'Calc: Fallh√∂he', type: 'calc', points: 2 },
    { id: 'F16', text: 'Calc: v=‚àö(2gh)', type: 'calc', points: 2 },
    { id: 'F17', text: 'Calc: Bremsweg', type: 'calc', points: 2 },
    { id: 'F18', text: 'Calc: Bremszeit', type: 'calc', points: 2 },
    { id: 'A', text: 'v(t) 8 Phasen', type: 'diagram', points: 8 },
    { id: 'B', text: 's(t) 4 Phasen', type: 'diagram', points: 4 },
    { id: 'C', text: 'a(t) Aufzug', type: 'diagram', points: 6 },
    { id: 'D', text: 'Zuordnung v‚Üîs', type: 'matching', points: 4 },
    { id: 'E', text: 'Komplexanalyse', type: 'mixed', points: 20 },
    { id: 'F', text: 'Ampelstart', type: 'multi', points: 10 },
    { id: 'BONUS', text: 'üéÑ Weihnachtsmann', type: 'bonus', points: 3 }
];

let html5QrCode = null;
let cameras = [];
let currentCameraId = null;
let scannerPaused = false;
let results = [];
let scannedCodes = new Set();

async function initCameras() {
    try {
        cameras = await Html5Qrcode.getCameras();
        const select = document.getElementById('cameraSelect');
        select.innerHTML = '';
        
        if (cameras.length === 0) {
            select.innerHTML = '<option value="">Keine Kamera gefunden</option>';
            updateScannerStatus('Keine Kamera verf√ºgbar', 'error');
            return;
        }
        
        cameras.forEach((cam, i) => {
            const opt = document.createElement('option');
            opt.value = cam.id;
            let label = cam.label || `Kamera ${i + 1}`;
            if (label.toLowerCase().includes('back') || label.toLowerCase().includes('rear') || label.toLowerCase().includes('r√ºck')) {
                label = 'üì∑ ' + label;
            } else if (label.toLowerCase().includes('front')) {
                label = 'ü§≥ ' + label;
            }
            opt.textContent = label;
            select.appendChild(opt);
        });
        
        // Letzte Kamera (oft R√ºckkamera) vorausw√§hlen
        currentCameraId = cameras[cameras.length - 1].id;
        select.value = currentCameraId;
        
        startScanner();
    } catch (err) {
        console.error('Kamera-Fehler:', err);
        updateScannerStatus('Kamera-Zugriff verweigert', 'error');
    }
}

async function startScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        await stopScanner();
    }
    
    if (!currentCameraId) {
        updateScannerStatus('Keine Kamera ausgew√§hlt', 'error');
        return;
    }
    
    try {
        html5QrCode = new Html5Qrcode("qr-reader");
        
        await html5QrCode.start(
            currentCameraId,
            {
                fps: 15,
                qrbox: { width: 350, height: 350 },
                aspectRatio: 1.0
            },
            onScanSuccess,
            onScanFailure
        );
        
        updateScannerStatus('Bereit zum Scannen', '');
        scannerPaused = false;
        document.getElementById('scannerToggleBtn').textContent = '‚è∏Ô∏è Pause';
    } catch (err) {
        console.error('Scanner-Fehler:', err);
        updateScannerStatus('Kamera-Zugriff verweigert', 'error');
    }
}

async function stopScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        try {
            await html5QrCode.stop();
        } catch (err) {
            console.warn('Fehler beim Stoppen:', err);
        }
    }
}

async function switchCamera() {
    const select = document.getElementById('cameraSelect');
    const newCameraId = select.value;
    
    if (newCameraId && newCameraId !== currentCameraId) {
        currentCameraId = newCameraId;
        updateScannerStatus('Kamera wird gewechselt...', '');
        await stopScanner();
        await startScanner();
    }
}

async function toggleScanner() {
    if (scannerPaused) {
        await startScanner();
    } else {
        await stopScanner();
        updateScannerStatus('Pausiert', '');
        scannerPaused = true;
        document.getElementById('scannerToggleBtn').textContent = '‚ñ∂Ô∏è Fortsetzen';
    }
}

function onScanSuccess(decodedText, decodedResult) {
    // Duplikat-Check
    if (scannedCodes.has(decodedText)) {
        updateScannerStatus('‚ö†Ô∏è Bereits gescannt!', '');
        return;
    }
    
    processCode(decodedText);
}

function onScanFailure(error) {
    // Ignorieren - normal wenn kein QR-Code im Bild
}

function processManualCode() {
    const code = document.getElementById('manualCode').value.trim();
    if (!code) {
        alert('Bitte Code eingeben!');
        return;
    }
    processCode(code);
    document.getElementById('manualCode').value = '';
}

function processCode(code) {
    try {
        const decoded = LZString.decompressFromEncodedURIComponent(code);
        if (!decoded) throw new Error('Ung√ºltiger Code');
        
        const data = JSON.parse(decoded);
        
        // Duplikat nach Sitzplatz pr√ºfen
        const existing = results.find(r => r.seat === data.s);
        if (existing) {
            if (!confirm(`${data.s} bereits vorhanden. √úberschreiben?`)) return;
            results = results.filter(r => r.seat !== data.s);
        }
        
        const result = {
            seat: data.s,
            points: data.p,
            bonus: data.b || 0,
            maxPoints: data.m || CONFIG.TOTAL_POINTS,
            time: data.t,
            duration: data.d,
            answers: data.a || [],
            grade: calculateGrade((data.p / (data.m || CONFIG.TOTAL_POINTS)) * 100)
        };
        
        results.push(result);
        scannedCodes.add(code);
        results.sort((a, b) => a.seat.localeCompare(b.seat));
        
        updateScannerStatus(`‚úÖ ${result.seat} gescannt!`, 'success');
        showScannedIndicator();
        playBeep();
        updateScannedCount();
        displayResults();
        
        setTimeout(() => {
            if (!scannerPaused) updateScannerStatus('Bereit zum Scannen', '');
        }, 1500);
        
    } catch (err) {
        console.error('Decode-Fehler:', err);
        updateScannerStatus('‚ùå Ung√ºltiger QR-Code', 'error');
        setTimeout(() => {
            if (!scannerPaused) updateScannerStatus('Bereit zum Scannen', '');
        }, 2000);
    }
}

function updateScannerStatus(message, type) {
    const status = document.getElementById('scannerStatus');
    status.textContent = message;
    status.classList.remove('success', 'error');
    if (type) status.classList.add(type);
}

function updateScannedCount() {
    document.getElementById('scannedCount').textContent = `‚úÖ ${results.length} gescannt`;
}

function showScannedIndicator() {
    const ind = document.getElementById('scannedIndicator');
    ind.classList.remove('show');
    void ind.offsetWidth; // Reflow
    ind.classList.add('show');
}

function playBeep() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 1000;
        osc.type = 'sine';
        gain.gain.value = 0.3;
        osc.start();
        osc.stop(ctx.currentTime + 0.15);
    } catch (e) {}
}

function calculateGrade(pct) {
    const th = [98.67, 97.33, 96, 90.67, 85.33, 80, 73.33, 66.67, 60, 53.33, 46.67, 40, 33.33, 26.67, 20];
    const gr = [15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1];
    for (let i = 0; i < th.length; i++) { if (pct >= th[i]) return gr[i]; }
    return 0;
}

function displayResults() {
    updateStats();
    
    const container = document.getElementById('resultsContainer');
    if (results.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="icon">üì∑</div><p>Noch keine Ergebnisse.</p></div>';
        return;
    }
    
    let html = `<div style="overflow-x:auto;"><table class="results-table">
        <thead><tr>
            <th>Platz</th><th>Punkte</th><th>%</th><th>Note</th><th>Bonus</th><th>Zeit</th><th>Aktionen</th>
        </tr></thead><tbody>`;
    
    results.forEach(r => {
        const pct = ((r.points / r.maxPoints) * 100).toFixed(1);
        const gradeClass = r.grade >= 10 ? 'good' : (r.grade >= 5 ? 'medium' : 'poor');
        const mins = Math.floor((r.duration || 0) / 60);
        const secs = (r.duration || 0) % 60;
        
        html += `<tr>
            <td><strong>${r.seat}</strong></td>
            <td class="points">${r.points} / ${r.maxPoints}</td>
            <td>${pct}%</td>
            <td><span class="grade-badge ${gradeClass}">${r.grade} NP</span></td>
            <td>${r.bonus > 0 ? 'üéÑ ' + r.bonus : '-'}</td>
            <td>${mins}:${String(secs).padStart(2, '0')}</td>
            <td>
                <button class="action-btn" onclick="showDetail('${r.seat}')">üìã</button>
                <button class="action-btn secondary" onclick="deleteResult('${r.seat}')">üóëÔ∏è</button>
            </td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function updateStats() {
    document.getElementById('statCount').textContent = results.length;
    
    if (results.length === 0) {
        document.getElementById('statAvgPoints').textContent = '--';
        document.getElementById('statAvgGrade').textContent = '--';
        document.getElementById('statBest').textContent = '--';
        document.getElementById('statWorst').textContent = '--';
        document.getElementById('statBonus').textContent = '--';
        return;
    }
    
    const avgP = results.reduce((s, r) => s + r.points, 0) / results.length;
    const avgG = results.reduce((s, r) => s + r.grade, 0) / results.length;
    const avgB = results.reduce((s, r) => s + r.bonus, 0) / results.length;
    const best = Math.max(...results.map(r => r.grade));
    const worst = Math.min(...results.map(r => r.grade));
    
    document.getElementById('statAvgPoints').textContent = avgP.toFixed(1);
    document.getElementById('statAvgGrade').textContent = avgG.toFixed(1);
    document.getElementById('statBest').textContent = best + ' NP';
    document.getElementById('statWorst').textContent = worst + ' NP';
    document.getElementById('statBonus').textContent = avgB.toFixed(1);
}

function showDetail(seat) {
    const r = results.find(res => res.seat === seat);
    if (!r) return;
    
    const pct = ((r.points / r.maxPoints) * 100).toFixed(1);
    const gradeClass = r.grade >= 10 ? 'good' : (r.grade >= 5 ? 'medium' : 'poor');
    const mins = Math.floor((r.duration || 0) / 60);
    const secs = (r.duration || 0) % 60;
    
    let html = `<div class="detail-grid">
        <div class="detail-item"><div class="label">Platz</div><div class="value">${r.seat}</div></div>
        <div class="detail-item"><div class="label">Punkte</div><div class="value">${r.points}/${r.maxPoints}</div></div>
        <div class="detail-item"><div class="label">Prozent</div><div class="value">${pct}%</div></div>
        <div class="detail-item"><div class="label">Note</div><div class="value"><span class="grade-badge ${gradeClass}">${r.grade} NP</span></div></div>
        <div class="detail-item"><div class="label">Bonus</div><div class="value">${r.bonus > 0 ? 'üéÑ ' + r.bonus : '-'}</div></div>
        <div class="detail-item"><div class="label">Zeit</div><div class="value">${mins}:${String(secs).padStart(2, '0')}</div></div>
    </div>`;
    
    if (r.answers && r.answers.length > 0) {
        html += '<h3 style="margin:15px 0 10px; font-size:0.95em;">Einzelergebnisse</h3><div class="question-results">';
        r.answers.forEach(a => {
            const q = QUESTIONS.find(q => q.id === a.q) || { text: a.q, points: '?' };
            const cls = a.c ? 'correct' : (a.p > 0 ? 'partial' : 'incorrect');
            html += `<div class="q-result ${cls}">
                <span class="q-id">${a.q}</span>
                <span style="flex:1; font-size:0.85em; color:#888;">${q.text}</span>
                <span class="q-points">${a.p}/${q.points || a.p}</span>
            </div>`;
        });
        html += '</div>';
    }
    
    document.getElementById('modalTitle').textContent = `Details: ${r.seat}`;
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('detailModal').classList.add('active');
}

function closeModal() {
    document.getElementById('detailModal').classList.remove('active');
}

function deleteResult(seat) {
    if (!confirm(`${seat} wirklich l√∂schen?`)) return;
    results = results.filter(r => r.seat !== seat);
    displayResults();
}

function clearAllResults() {
    if (!confirm('ALLE Ergebnisse l√∂schen?')) return;
    results = [];
    scannedCodes.clear();
    displayResults();
    updateScannedCount();
}

function exportCSV() {
    if (results.length === 0) { alert('Keine Daten zum Exportieren!'); return; }
    
    let csv = 'Platz;Punkte;Max;Prozent;Note;Bonus;Zeit_min';
    QUESTIONS.forEach(q => { csv += `;${q.id}`; });
    csv += '\n';
    
    results.forEach(r => {
        const pct = ((r.points / r.maxPoints) * 100).toFixed(1);
        const mins = ((r.duration || 0) / 60).toFixed(1);
        csv += `${r.seat};${r.points};${r.maxPoints};${pct};${r.grade};${r.bonus};${mins}`;
        QUESTIONS.forEach(q => {
            const a = r.answers.find(ans => ans.q === q.id);
            csv += `;${a ? a.p : ''}`;
        });
        csv += '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `quiz_ergebnisse_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
}

function printAllFeedback() {
    if (results.length === 0) { alert('Keine Ergebnisse!'); return; }
    
    let html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
        <title>Feedbackb√∂gen</title>
        <style>
            body { font-family: Arial, sans-serif; font-size: 10pt; }
            .page { page-break-after: always; padding: 15px; }
            .page:last-child { page-break-after: auto; }
            h2 { margin: 0 0 10px; font-size: 14pt; }
            .header { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #000; }
            .grade { font-size: 24pt; font-weight: bold; }
            .good { color: #2e7d32; }
            .medium { color: #e65100; }
            .poor { color: #c62828; }
            table { width: 100%; border-collapse: collapse; margin: 10px 0; }
            th, td { border: 1px solid #ccc; padding: 5px 8px; text-align: left; font-size: 9pt; }
            th { background: #f0f0f0; }
            .correct { background: #e8f5e9; }
            .partial { background: #fff3e0; }
            .incorrect { background: #ffebee; }
        </style>
    </head><body>`;
    
    results.forEach(r => {
        const pct = ((r.points / r.maxPoints) * 100).toFixed(1);
        const gradeClass = r.grade >= 10 ? 'good' : (r.grade >= 5 ? 'medium' : 'poor');
        
        html += `<div class="page">
            <div class="header">
                <div>
                    <h2>Stundenleistung Bewegungslehre ‚Äì Klasse 10 GY</h2>
                    <p>Name: _________________ Platz: <strong>${r.seat}</strong> Datum: ${new Date().toLocaleDateString('de-DE')}</p>
                </div>
                <div style="text-align:right;">
                    <div class="grade ${gradeClass}">${r.grade} NP</div>
                    <div>${r.points}/${r.maxPoints} P (${pct}%)</div>
                    ${r.bonus > 0 ? `<div>üéÑ Bonus: ${r.bonus} P</div>` : ''}
                </div>
            </div>
            <table><thead><tr><th>Aufgabe</th><th>Thema</th><th>Punkte</th><th>Max</th></tr></thead><tbody>`;
        
        r.answers.forEach(a => {
            const q = QUESTIONS.find(q => q.id === a.q) || { text: a.q, points: '?' };
            const cls = a.c ? 'correct' : (a.p > 0 ? 'partial' : 'incorrect');
            html += `<tr class="${cls}"><td><strong>${a.q}</strong></td><td>${q.text}</td><td>${a.p}</td><td>${q.points}</td></tr>`;
        });
        
        html += `</tbody></table>
            <p style="margin-top:20px;">Unterschrift Lehrkraft: _________________ Datum: _________</p>
        </div>`;
    });
    
    html += '</body></html>';
    
    const win = window.open('', '_blank');
    win.document.write(html);
    win.document.close();
    win.print();
}

function showTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector(`.tab:nth-child(${tab === 'scan' ? 1 : tab === 'results' ? 2 : 3})`).classList.add('active');
    document.getElementById(tab + 'Tab').classList.add('active');
}

document.getElementById('detailModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

document.addEventListener('DOMContentLoaded', () => {
    initCameras();
    displayResults();
});
</script>
</body>
</html>
