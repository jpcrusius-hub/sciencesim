<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decoder V5.4 ‚Äì Bewegungslehre Klasse 10 GY</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #f5f5f5; 
            min-height: 100vh; 
            padding: 15px; 
        }
        .container { max-width: 1100px; margin: 0 auto; }
        h1 { 
            font-size: 1.3em; 
            font-weight: 600; 
            color: #222; 
            margin-bottom: 15px; 
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .badge { 
            display: inline-block; 
            padding: 3px 10px; 
            border-radius: 4px; 
            font-size: 0.75em; 
            font-weight: 600; 
        }
        .badge.version { background: #e3f2fd; color: #1565c0; }
        .badge.points { background: #e8f5e9; color: #2e7d32; }
        
        .box { 
            background: #fff; 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-bottom: 15px; 
            border-radius: 6px; 
        }
        .box h2 { 
            font-size: 1em; 
            font-weight: 600; 
            color: #222; 
            margin-bottom: 10px; 
            padding-bottom: 8px; 
            border-bottom: 2px solid #2c5aa0; 
        }
        
        /* Input Toggle */
        .input-toggle {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #2c5aa0;
        }
        .toggle-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: #fff;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            color: #2c5aa0;
            transition: all 0.2s;
        }
        .toggle-btn:first-child { border-right: 1px solid #2c5aa0; }
        .toggle-btn.active { background: #2c5aa0; color: #fff; }
        .toggle-btn:hover:not(.active) { background: #e3f2fd; }
        
        /* Scanner */
        .scanner-container {
            display: none;
            background: #1a1a2e;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        .scanner-container.active { display: block; }
        #qr-reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        #qr-reader video { border-radius: 0; }
        .scanner-status {
            padding: 12px;
            text-align: center;
            background: #1a1a2e;
            color: #fff;
            font-size: 0.95em;
            font-weight: 500;
        }
        .scanner-status.success { background: #2e7d32; }
        .scanner-status.error { background: #c62828; }
        .scanner-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            padding: 12px;
            background: #252545;
            flex-wrap: wrap;
        }
        .scanned-count {
            background: #4caf50;
            color: #fff;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        /* Camera Select */
        .camera-select-container {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1a1a2e;
            padding: 10px 15px;
            border-bottom: 1px solid #333;
        }
        .camera-select-container label {
            color: #aaa;
            font-size: 0.85em;
            white-space: nowrap;
        }
        .camera-select {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.9em;
            border: 1px solid #444;
            border-radius: 4px;
            background: #252545;
            color: #fff;
            cursor: pointer;
            max-width: 300px;
        }
        .camera-select:focus { outline: none; border-color: #2c5aa0; }
        
        /* Textarea */
        .text-container { display: none; }
        .text-container.active { display: block; }
        textarea { 
            width: 100%; 
            height: 120px; 
            padding: 12px; 
            font-family: "SF Mono", Monaco, monospace; 
            font-size: 0.85em; 
            border: 2px solid #ddd; 
            resize: vertical; 
            border-radius: 6px; 
        }
        textarea:focus { outline: none; border-color: #2c5aa0; }
        
        /* Buttons */
        button { 
            padding: 10px 20px; 
            font-size: 0.9em; 
            border: 1px solid #ccc; 
            background: #fff; 
            cursor: pointer; 
            font-family: inherit; 
            margin: 3px; 
            border-radius: 4px;
            transition: all 0.15s;
        }
        button:hover { background: #f5f5f5; }
        button.primary { background: #2c5aa0; color: #fff; border-color: #2c5aa0; }
        button.primary:hover { background: #234a80; }
        button.success { background: #2a7a4b; color: #fff; border-color: #2a7a4b; }
        button.success:hover { background: #1e5a37; }
        button.danger { background: #c62828; color: #fff; border-color: #c62828; }
        button.danger:hover { background: #a31f1f; }
        button.scanner-btn {
            background: #3a3a5a;
            color: #fff;
            border-color: #3a3a5a;
            padding: 8px 16px;
            font-size: 0.85em;
        }
        button.scanner-btn:hover { background: #4a4a6a; }
        
        /* Scale Table */
        .scale-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.75em; 
            margin: 10px 0; 
            overflow-x: auto;
            display: block;
        }
        .scale-table th, .scale-table td { 
            border: 1px solid #ddd; 
            padding: 4px 6px; 
            text-align: center; 
        }
        .scale-table th { background: #2c5aa0; color: #fff; }
        .scale-table tr:nth-child(even) { background: #f9f9f9; }
        
        /* Stats Grid */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 10px; 
            margin: 15px 0; 
        }
        .stat-box { 
            background: #f5f5f5; 
            border: 1px solid #ddd; 
            padding: 12px; 
            text-align: center; 
            border-radius: 6px; 
        }
        .stat-box .value { font-size: 1.5em; font-weight: 700; color: #2c5aa0; }
        .stat-box .label { font-size: 0.75em; color: #666; margin-top: 4px; }
        
        /* Results Table */
        .results-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 15px; 
        }
        .results-table th, .results-table td { 
            border: 1px solid #ddd; 
            padding: 10px 12px; 
            text-align: left; 
            font-size: 0.9em; 
        }
        .results-table th { background: #f5f5f5; font-weight: 600; }
        .results-table tr:hover { background: #fafafa; }
        
        .grade { font-weight: 700; }
        .grade-good { color: #2a7a4b; }
        .grade-ok { color: #b35c00; }
        .grade-bad { color: #c00; }
        
        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0,0,0,0.6); 
            z-index: 1000; 
            overflow-y: auto; 
            padding: 20px; 
        }
        .modal.active { display: block; }
        .modal-content { 
            background: #fff; 
            max-width: 900px; 
            margin: 0 auto; 
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header { 
            background: #2c5aa0; 
            color: #fff; 
            padding: 15px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .modal-header h3 { font-size: 1.1em; }
        .close-btn { 
            background: none; 
            border: none; 
            color: #fff; 
            font-size: 1.5em; 
            cursor: pointer; 
            padding: 0; 
            margin: 0; 
            line-height: 1;
        }
        .modal-body { padding: 20px; }
        
        /* Answer Rows */
        .answer-row { 
            display: flex; 
            align-items: flex-start; 
            padding: 10px 12px; 
            margin: 6px 0; 
            border-radius: 6px; 
            border-left: 4px solid #ddd; 
            flex-wrap: wrap;
            gap: 10px;
            background: #fafafa;
        }
        .answer-row.correct { background: #e8f5e9; border-left-color: #4caf50; }
        .answer-row.incorrect { background: #ffebee; border-left-color: #f44336; }
        .answer-row.partial { background: #fff8e1; border-left-color: #ff9800; }
        .answer-row.bonus { background: #fce4ec; border-left-color: #9c27b0; }
        .answer-row .q-num { 
            min-width: 50px; 
            font-weight: 600; 
            color: #333; 
            font-size: 0.9em; 
        }
        .answer-row .q-info { 
            flex: 1; 
            font-size: 0.85em; 
            min-width: 200px;
            color: #555;
        }
        .answer-row .q-points { 
            font-weight: 600; 
            min-width: 60px; 
            text-align: right; 
            font-size: 0.9em; 
        }
        
        /* Error Message */
        .error-message {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }
        .error-message.visible { display: block; }
        
        /* Print */
        @media print { 
            body { background: #fff; padding: 10px; font-size: 9pt; } 
            .box { border: 1px solid #000; page-break-inside: avoid; } 
            button, textarea, .modal, .scanner-container, .input-toggle { display: none !important; }
            .text-container { display: none !important; }
            .results-table { font-size: 8pt; }
        }
        
        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .results-table { font-size: 0.8em; }
            .results-table th, .results-table td { padding: 6px 8px; }
            .scanner-controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            üîì Decoder V5.4 ‚Äì Bewegungslehre 10 GY
            <span class="badge version">V5</span>
            <span class="badge points">108P + 3 Bonus</span>
        </h1>
        
        <div class="box">
            <h2>üì• Ergebnisse erfassen</h2>
            
            <div class="input-toggle">
                <button class="toggle-btn active" id="scannerToggle" onclick="setInputMode('scanner')">üì∑ QR scannen</button>
                <button class="toggle-btn" id="textToggle" onclick="setInputMode('text')">üìù Text eingeben</button>
            </div>
            
            <div class="scanner-container active" id="scannerContainer">
                <div class="camera-select-container">
                    <label for="cameraSelect">üì∑ Kamera:</label>
                    <select class="camera-select" id="cameraSelect" onchange="switchToCamera()">
                        <option value="">Wird geladen...</option>
                    </select>
                </div>
                <div id="qr-reader"></div>
                <div class="scanner-status" id="scannerStatus">Kamera wird gestartet...</div>
                <div class="scanner-controls">
                    <button class="scanner-btn" onclick="toggleScanner()" id="scannerToggleBtn">‚è∏Ô∏è Pause</button>
                    <span class="scanned-count" id="scannedCount">‚úÖ 0 gescannt</span>
                </div>
            </div>
            
            <div class="text-container" id="textContainer">
                <textarea id="codeInput" placeholder="F√ºge hier einen oder mehrere Codes ein (einer pro Zeile)..."></textarea>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            
            <p style="margin-top: 12px;">
                <button class="primary" onclick="decodeAll()">üîì Dekodieren</button>
                <button onclick="clearAll()">üóëÔ∏è L√∂schen</button>
                <button class="success" onclick="exportCSV()">üìä CSV Export</button>
            </p>
        </div>
        
        <div class="box">
            <h2>üìè Bewertungsskala (15-NP, Sonstige Leistungen)</h2>
            <p style="margin-bottom: 8px; font-size: 0.9em;">
                Gesamt: <strong>108 Punkte</strong> + 3 Bonus | 
                Hilfsmittel: Keine | 
                g = 10 m/s¬≤
            </p>
            <table class="scale-table">
                <tr>
                    <th>NP</th><th>15</th><th>14</th><th>13</th><th>12</th><th>11</th><th>10</th><th>9</th><th>8</th><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th>
                </tr>
                <tr>
                    <td>%</td><td>98,7</td><td>97,3</td><td>96</td><td>90,7</td><td>85,3</td><td>80</td><td>73,3</td><td>66,7</td><td>60</td><td>53,3</td><td>46,7</td><td>40</td><td>33,3</td><td>26,7</td><td>20</td>
                </tr>
                <tr>
                    <td>P</td><td>107</td><td>105</td><td>104</td><td>98</td><td>92</td><td>86</td><td>79</td><td>72</td><td>65</td><td>58</td><td>50</td><td>43</td><td>36</td><td>29</td><td>22</td>
                </tr>
            </table>
        </div>
        
        <div class="box" id="resultsBox" style="display:none;">
            <h2>üìä Ergebnisse</h2>
            <div class="stats-grid" id="statsGrid"></div>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Platz</th>
                        <th>Punkte</th>
                        <th>%</th>
                        <th>NP</th>
                        <th>Bonus</th>
                        <th>Zeit</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
            <p style="margin-top: 15px; text-align: center;">
                <button onclick="window.print()">üñ®Ô∏è Drucken</button>
                <button class="success" onclick="generateAllSheets()">üìÑ Alle Feedbackb√∂gen</button>
            </p>
        </div>
    </div>
    
    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Detail</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

<script>
// =============================================================================
// KONFIGURATION
// =============================================================================
const MAX_POINTS = 88;
const MAX_BONUS = 3;

const SCALE = {
    thresholds: [98.67, 97.33, 96, 90.67, 85.33, 80, 73.33, 66.67, 60, 53.33, 46.67, 40, 33.33, 26.67, 20],
    grades: [15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1]
};

// Fragen-Referenz f√ºr Detail-Ansicht
const QUESTIONS = [
    { id: 'F1', text: 'Wie ver√§ndert sich s bei v = const?', fullText: 's nimmt linear zu (s ~ t)', type: 'mc', points: 2, correct: 'B' },
    { id: 'F2', text: 'Einheit der Beschleunigung', fullText: 'm/s¬≤', type: 'mc', points: 2, correct: 'B' },
    { id: 'F3', text: 'Anstieg im s(t)-Diagramm', fullText: 'Geschwindigkeit', type: 'mc', points: 2, correct: 'B' },
    { id: 'F4', text: 'Anstieg im v(t)-Diagramm', fullText: 'Beschleunigung', type: 'mc', points: 2, correct: 'C' },
    { id: 'F5', text: 'Fl√§che unter v(t)', fullText: 'Zur√ºckgelegter Weg', type: 'mc', points: 2, correct: 'C' },
    { id: 'F6', text: 'Fl√§che unter a(t)', fullText: 'Geschwindigkeits√§nderung Œîv', type: 'mc', points: 2, correct: 'B' },
    { id: 'F7', text: 'Waagerechte Linie im v(t)', fullText: 'Gleichf√∂rmige Bewegung (v = const)', type: 'mc', points: 2, correct: 'A' },
    { id: 'F8', text: 'Parabel im s(t)-Diagramm', fullText: 'Beschleunigte Bewegung', type: 'mc', points: 2, correct: 'B' },
    { id: 'F9', text: 'Gerade durch Ursprung im v(t)', fullText: 'Konstante Beschleunigung aus Ruhe', type: 'mc', points: 2, correct: 'A' },
    { id: 'F10', text: 'Negative Fl√§che im v(t)', fullText: 'Bewegung in negativer Richtung', type: 'mc', points: 2, correct: 'B' },
    { id: 'F11', text: '108 km/h ‚Üí m/s', fullText: '30 m/s', type: 'calc', points: 2, correct: '30 m/s' },
    { id: 'F12', text: 's = v¬∑t (5 m/s, 40 s)', fullText: '200 m', type: 'calc', points: 2, correct: '200 m' },
    { id: 'F13', text: 'v = a¬∑t (5 m/s¬≤, 6 s)', fullText: '30 m/s', type: 'calc', points: 2, correct: '30 m/s' },
    { id: 'F14', text: 's = ¬Ωat¬≤ (4 m/s¬≤, 5 s)', fullText: '50 m', type: 'calc', points: 2, correct: '50 m' },
    { id: 'F15', text: 'Fallh√∂he nach 4 s (g=10)', fullText: '80 m', type: 'calc', points: 2, correct: '80 m' },
    { id: 'F16', text: 'v bei h = 45 m (g=10)', fullText: '30 m/s', type: 'calc', points: 2, correct: '30 m/s' },
    { id: 'F17', text: 'Bremsweg (40 m/s, -8 m/s¬≤)', fullText: '100 m', type: 'calc', points: 2, correct: '100 m' },
    { id: 'F18', text: 'Bremszeit (30 m/s, -6 m/s¬≤)', fullText: '5 s', type: 'calc', points: 2, correct: '5 s' },
    { id: 'A', text: 'v(t) Auto (8 Phasen)', fullText: 'Beschl., Gleichf., Beschl., Gleichf., Verz√∂g., Gleichf., Verz√∂g., Stillstand', type: 'diagram', points: 8, correct: [0,1,0,1,2,1,2,3] },
    { id: 'B', text: 's(t) Radfahrer (4 Phasen)', fullText: 'Beschl., Gleichf., Stillstand, Gleichf.', type: 'diagram', points: 4, correct: [0,1,2,1] },
    { id: 'C', text: 'a(t) Aufzug (6 Phasen)', fullText: 'Beschl., Gleichf., Beschl., Gleichf., Verz√∂g., Stillstand', type: 'diagram', points: 6, correct: [0,1,0,1,2,3] },
    { id: 'D', text: 'Zuordnung v(t) ‚Üî s(t)', fullText: 'I‚ÜíA, II‚ÜíB, III‚ÜíC, IV‚ÜíD', type: 'matching', points: 4, correct: [0,1,2,3] },
    { id: 'E', text: 'Komplexe v(t)-Analyse (10 Teile)', fullText: '10 m/s¬≤, 90 m, -5 m/s¬≤, 67,5 m, 45 m, 247,5 m', type: 'mixed', points: 20 },
    { id: 'F', text: 'PKW Ampelstart (5 Teile)', fullText: 'v=20 m/s, s‚ÇÅ=50 m, s‚ÇÇ=200 m, t=2,5 s, s‚ÇÉ=25 m', type: 'multi', points: 10 },
    { id: 'BONUS', text: 'üéÑ Weihnachtsmann MV', fullText: '200.000 km, ~27.778 m/s, ~82 Mach', type: 'bonus', points: 3 }
];

// =============================================================================
// GLOBALE VARIABLEN
// =============================================================================
let results = [];
let scannedCodes = new Set();
let html5QrCode = null;
let scannerPaused = false;
let cameras = [];
let currentCameraId = null;

// =============================================================================
// INPUT MODE
// =============================================================================
function setInputMode(mode) {
    document.getElementById('scannerToggle').classList.toggle('active', mode === 'scanner');
    document.getElementById('textToggle').classList.toggle('active', mode === 'text');
    
    const scannerContainer = document.getElementById('scannerContainer');
    const textContainer = document.getElementById('textContainer');
    
    if (mode === 'scanner') {
        scannerContainer.classList.add('active');
        textContainer.classList.remove('active');
        startScanner();
    } else {
        scannerContainer.classList.remove('active');
        textContainer.classList.add('active');
        stopScanner();
    }
}

// =============================================================================
// QR SCANNER MIT KAMERA-AUSWAHL
// =============================================================================
async function initCameras() {
    try {
        cameras = await Html5Qrcode.getCameras();
        const select = document.getElementById('cameraSelect');
        select.innerHTML = '';
        
        if (cameras && cameras.length > 0) {
            cameras.forEach((camera, index) => {
                const option = document.createElement('option');
                option.value = camera.id;
                // Versuche, die Kamera-Beschreibung lesbarer zu machen
                let label = camera.label || `Kamera ${index + 1}`;
                // K√ºrzen wenn zu lang
                if (label.length > 40) {
                    label = label.substring(0, 37) + '...';
                }
                // R√ºckkamera hervorheben
                if (label.toLowerCase().includes('back') || label.toLowerCase().includes('r√ºck') || label.toLowerCase().includes('rear')) {
                    label = 'üì∑ ' + label + ' (R√ºck)';
                } else if (label.toLowerCase().includes('front') || label.toLowerCase().includes('vorn')) {
                    label = 'ü§≥ ' + label + ' (Front)';
                }
                option.textContent = label;
                select.appendChild(option);
            });
            
            // Standardm√§√üig letzte Kamera (oft R√ºckkamera) ausw√§hlen
            currentCameraId = cameras[cameras.length - 1].id;
            select.value = currentCameraId;
        } else {
            select.innerHTML = '<option value="">Keine Kamera gefunden</option>';
        }
    } catch (err) {
        console.error('Fehler beim Laden der Kameras:', err);
        document.getElementById('cameraSelect').innerHTML = '<option value="">Fehler beim Laden</option>';
    }
}

async function startScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        await stopScanner();
    }
    
    if (!cameras || cameras.length === 0) {
        await initCameras();
    }
    
    if (!currentCameraId && cameras.length > 0) {
        currentCameraId = cameras[cameras.length - 1].id;
    }
    
    if (!currentCameraId) {
        updateScannerStatus('Keine Kamera verf√ºgbar', 'error');
        return;
    }
    
    try {
        html5QrCode = new Html5Qrcode("qr-reader");
        
        await html5QrCode.start(
            currentCameraId,
            {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            },
            onScanSuccess,
            onScanFailure
        );
        
        updateScannerStatus('Bereit zum Scannen', '');
        scannerPaused = false;
        document.getElementById('scannerToggleBtn').textContent = '‚è∏Ô∏è Pause';
    } catch (err) {
        console.error('Scanner-Fehler:', err);
        updateScannerStatus('Kamera-Zugriff verweigert', 'error');
    }
}

async function stopScanner() {
    if (html5QrCode && html5QrCode.isScanning) {
        try {
            await html5QrCode.stop();
        } catch (err) {
            console.warn('Fehler beim Stoppen:', err);
        }
    }
}

async function switchToCamera() {
    const select = document.getElementById('cameraSelect');
    const newCameraId = select.value;
    
    if (newCameraId && newCameraId !== currentCameraId) {
        currentCameraId = newCameraId;
        updateScannerStatus('Kamera wird gewechselt...', '');
        await stopScanner();
        await startScanner();
    }
}

async function toggleScanner() {
    if (scannerPaused) {
        await startScanner();
    } else {
        await stopScanner();
        updateScannerStatus('Pausiert', '');
        scannerPaused = true;
        document.getElementById('scannerToggleBtn').textContent = '‚ñ∂Ô∏è Fortsetzen';
    }
}

function onScanSuccess(decodedText, decodedResult) {
    // Duplikat-Check
    if (scannedCodes.has(decodedText)) {
        updateScannerStatus('‚ö†Ô∏è Bereits gescannt!', '');
        return;
    }
    
    // Dekodieren versuchen
    try {
        const decoded = LZString.decompressFromEncodedURIComponent(decodedText);
        if (!decoded) throw new Error('Ung√ºltiger Code');
        
        const data = JSON.parse(decoded);
        const result = processResult(data);
        
        if (result) {
            scannedCodes.add(decodedText);
            updateScannedCount();
            updateScannerStatus(`‚úÖ ${result.seatId} gescannt!`, 'success');
            
            // Audio-Feedback
            playBeep();
            
            // Nach kurzer Pause Status zur√ºcksetzen
            setTimeout(() => {
                if (!scannerPaused) {
                    updateScannerStatus('Bereit zum Scannen', '');
                }
            }, 1500);
            
            displayResults();
        }
    } catch (err) {
        updateScannerStatus('‚ùå Ung√ºltiger QR-Code', 'error');
        setTimeout(() => {
            if (!scannerPaused) {
                updateScannerStatus('Bereit zum Scannen', '');
            }
        }, 2000);
    }
}

function onScanFailure(error) {
    // Ignorieren - das ist normal wenn kein QR-Code im Bild ist
}

function updateScannerStatus(message, type) {
    const status = document.getElementById('scannerStatus');
    status.textContent = message;
    status.classList.remove('success', 'error');
    if (type) status.classList.add(type);
}

function updateScannedCount() {
    document.getElementById('scannedCount').textContent = `‚úÖ ${scannedCodes.size} gescannt`;
}

function playBeep() {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.3;
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.15);
    } catch (e) {
        // Audio nicht verf√ºgbar - ignorieren
    }
}

// =============================================================================
// DEKODIEREN
// =============================================================================
function decodeAll() {
    const input = document.getElementById('codeInput').value.trim();
    
    if (!input && scannedCodes.size === 0) {
        showError('Bitte Codes eingeben oder scannen.');
        return;
    }
    
    hideError();
    let errors = [];
    
    // Text-Eingabe verarbeiten
    if (input) {
        const codes = input.split('\n').map(c => c.trim()).filter(c => c.length > 0);
        
        codes.forEach((code, i) => {
            if (scannedCodes.has(code)) return; // Bereits gescannt
            
            try {
                const decoded = LZString.decompressFromEncodedURIComponent(code);
                if (!decoded) throw new Error('Ung√ºltig');
                
                const data = JSON.parse(decoded);
                if (processResult(data)) {
                    scannedCodes.add(code);
                }
            } catch (e) {
                errors.push(`Zeile ${i + 1}`);
            }
        });
    }
    
    if (results.length > 0) {
        displayResults();
        if (errors.length > 0) {
            showError(`${errors.length} fehlerhafte Codes: ${errors.join(', ')}`);
        }
    } else {
        showError('Keine g√ºltigen Codes gefunden.');
    }
}

function processResult(data) {
    // Duplikat-Check nach Sitzplatz
    const existing = results.findIndex(r => r.seatId === data.s);
    
    const result = {
        seatId: data.s,
        totalPoints: data.p || 0,
        bonusPoints: data.b || 0,
        maxPoints: data.m || MAX_POINTS,
        duration: data.d || 0,
        timestamp: data.t,
        answers: data.a || [],
        percentage: ((data.p || 0) / MAX_POINTS) * 100,
        grade: calculateGrade(((data.p || 0) / MAX_POINTS) * 100)
    };
    
    if (existing >= 0) {
        // Aktualisieren falls neuere Version
        results[existing] = result;
    } else {
        results.push(result);
    }
    
    return result;
}

function calculateGrade(pct) {
    for (let i = 0; i < SCALE.thresholds.length; i++) {
        if (pct >= SCALE.thresholds[i]) return SCALE.grades[i];
    }
    return 0;
}

// =============================================================================
// ERGEBNISSE ANZEIGEN
// =============================================================================
function displayResults() {
    if (results.length === 0) {
        document.getElementById('resultsBox').style.display = 'none';
        return;
    }
    
    document.getElementById('resultsBox').style.display = 'block';
    
    // Sortieren nach Sitzplatz
    results.sort((a, b) => a.seatId.localeCompare(b.seatId));
    
    // Statistiken
    const stats = calculateStats();
    document.getElementById('statsGrid').innerHTML = `
        <div class="stat-box">
            <div class="value">${stats.avg.toFixed(1)}</div>
            <div class="label">√ò Punkte</div>
        </div>
        <div class="stat-box">
            <div class="value">${stats.avgGrade.toFixed(1)}</div>
            <div class="label">√ò Note</div>
        </div>
        <div class="stat-box">
            <div class="value">${stats.best}</div>
            <div class="label">Beste</div>
        </div>
        <div class="stat-box">
            <div class="value">${stats.worst}</div>
            <div class="label">Schw√§chste</div>
        </div>
        <div class="stat-box">
            <div class="value">${results.length}</div>
            <div class="label">Anzahl</div>
        </div>
        <div class="stat-box">
            <div class="value">${stats.avgBonus.toFixed(1)}</div>
            <div class="label">√ò Bonus</div>
        </div>
    `;
    
    // Tabelle
    let tbody = '';
    results.forEach((r, i) => {
        const gradeClass = r.grade >= 10 ? 'grade-good' : (r.grade >= 5 ? 'grade-ok' : 'grade-bad');
        const duration = formatDuration(r.duration);
        
        tbody += `<tr>
            <td><strong>${r.seatId}</strong></td>
            <td>${r.totalPoints} / ${MAX_POINTS}</td>
            <td>${r.percentage.toFixed(1)}%</td>
            <td class="grade ${gradeClass}">${r.grade} NP</td>
            <td>${r.bonusPoints} / ${MAX_BONUS}</td>
            <td>${duration}</td>
            <td>
                <button onclick="showDetail(${i})" style="padding:5px 10px; font-size:0.85em;">üîç Details</button>
            </td>
        </tr>`;
    });
    
    document.getElementById('resultsBody').innerHTML = tbody;
}

function calculateStats() {
    const points = results.map(r => r.totalPoints);
    const grades = results.map(r => r.grade);
    const bonus = results.map(r => r.bonusPoints);
    
    return {
        avg: points.reduce((a, b) => a + b, 0) / points.length,
        avgGrade: grades.reduce((a, b) => a + b, 0) / grades.length,
        best: Math.max(...points),
        worst: Math.min(...points),
        avgBonus: bonus.reduce((a, b) => a + b, 0) / bonus.length
    };
}

function formatDuration(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${String(secs).padStart(2, '0')}`;
}

// =============================================================================
// DETAIL-ANSICHT
// =============================================================================
function showDetail(index) {
    const r = results[index];
    const gradeClass = r.grade >= 10 ? 'grade-good' : (r.grade >= 5 ? 'grade-ok' : 'grade-bad');
    
    document.getElementById('modalTitle').textContent = `${r.seatId} ‚Äì ${r.totalPoints}/${MAX_POINTS} P (${r.grade} NP)`;
    
    let html = `
        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-bottom:20px;">
            <div class="stat-box">
                <div class="value ${gradeClass}">${r.grade}</div>
                <div class="label">Notenpunkte</div>
            </div>
            <div class="stat-box">
                <div class="value">${r.totalPoints}</div>
                <div class="label">Punkte</div>
            </div>
            <div class="stat-box">
                <div class="value">${r.percentage.toFixed(1)}%</div>
                <div class="label">Prozent</div>
            </div>
            <div class="stat-box">
                <div class="value">${r.bonusPoints}</div>
                <div class="label">Bonus</div>
            </div>
            <div class="stat-box">
                <div class="value">${formatDuration(r.duration)}</div>
                <div class="label">Zeit</div>
            </div>
        </div>
        <h4 style="margin-bottom:10px;">Antworten im Detail:</h4>
    `;
    
    r.answers.forEach((a, i) => {
        const q = QUESTIONS.find(qu => qu.id === a.q) || { id: a.q, text: a.q, points: 2 };
        const statusClass = a.c ? 'correct' : (a.p > 0 ? 'partial' : 'incorrect');
        const statusIcon = a.c ? '‚úÖ' : (a.p > 0 ? '‚ö†Ô∏è' : '‚ùå');
        
        html += `<div class="answer-row ${statusClass}${q.id === 'BONUS' ? ' bonus' : ''}">
            <div class="q-num">${statusIcon} ${a.q}</div>
            <div class="q-info">
                <strong>${q.text}</strong><br>
                <span style="color:#666;">`;
        
        // Sch√ºler-Antwort anzeigen
        html += `<span style="color:#1565c0;">Sch√ºler:</span> `;
        if (a.a !== null && a.a !== undefined) {
            html += formatAnswer(a.a);
        } else {
            html += '<em>Keine Antwort</em>';
        }
        
        // Richtige Antwort anzeigen (falls falsch)
        if (!a.c) {
            html += `<br><span style="color:#2e7d32;">Richtig:</span> `;
            if (a.ca !== undefined) {
                html += formatAnswer(a.ca);
            } else if (q.fullText) {
                html += q.fullText;
            } else if (q.correct !== undefined) {
                html += formatAnswer(q.correct);
            } else {
                html += '‚Äì';
            }
        }
        
        html += `</span></div>
            <div class="q-points">${a.p}/${q.points} P</div>
        </div>`;
    });
    
    document.getElementById('modalBody').innerHTML = html;
    document.getElementById('detailModal').classList.add('active');
}

// Hilfsfunktion zum Formatieren von Antworten
function formatAnswer(answer) {
    if (answer === null || answer === undefined) return '‚Äì';
    
    if (typeof answer === 'object') {
        if (answer.value !== undefined) {
            return `${answer.value} ${answer.unit || ''}`;
        } else if (answer.value1 !== undefined) {
            return `${answer.value1}, ${answer.value2} ${answer.unit || ''}`;
        } else if (Array.isArray(answer)) {
            return `[${answer.map(x => x !== null ? x : '‚Äì').join(', ')}]`;
        } else {
            // Fields object
            const fieldAnswers = Object.entries(answer).map(([k, v]) => {
                if (typeof v === 'object' && v !== null) {
                    if (v.value !== undefined) return `${k}: ${v.value} ${v.unit || ''}`;
                    if (v.value1 !== undefined) return `${k}: ${v.value1}, ${v.value2} ${v.unit || ''}`;
                }
                return `${k}: ${v !== null ? v : '‚Äì'}`;
            }).join(' | ');
            return fieldAnswers;
        }
    } else {
        const letters = ['A', 'B', 'C', 'D'];
        return typeof answer === 'number' && answer < 4 ? letters[answer] : String(answer);
    }
}

function closeModal() {
    document.getElementById('detailModal').classList.remove('active');
}

// Modal schlie√üen bei Klick au√üerhalb
document.getElementById('detailModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

// =============================================================================
// EXPORT & UTILITIES
// =============================================================================
function clearAll() {
    results = [];
    scannedCodes.clear();
    document.getElementById('resultsBox').style.display = 'none';
    document.getElementById('codeInput').value = '';
    updateScannedCount();
    hideError();
}

function exportCSV() {
    if (results.length === 0) {
        showError('Keine Ergebnisse zum Exportieren!');
        return;
    }
    
    // Header mit allen Fragen
    let csv = 'Platz;Punkte;Max;Prozent;NP;Bonus;Zeit_Sek;';
    csv += QUESTIONS.map(q => q.id).join(';');
    csv += '\n';
    
    results.forEach(r => {
        csv += `${r.seatId};${r.totalPoints};${r.maxPoints};${r.percentage.toFixed(1)};${r.grade};${r.bonusPoints};${r.duration};`;
        
        // Punkte pro Frage
        QUESTIONS.forEach(q => {
            const ans = r.answers.find(a => a.q === q.id);
            csv += (ans ? ans.p : 0) + ';';
        });
        csv = csv.slice(0, -1) + '\n'; // Letztes Semikolon entfernen
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Ergebnisse_Bewegungslehre_10GY_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function generateAllSheets() {
    if (results.length === 0) {
        showError('Keine Ergebnisse vorhanden!');
        return;
    }
    
    const win = window.open('', '_blank');
    let html = `<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Feedbackb√∂gen ‚Äì Bewegungslehre 10 GY</title>
        <style>
            body { font-family: Arial, sans-serif; font-size: 10pt; margin: 0; padding: 15px; }
            .sheet { page-break-after: always; border: 1px solid #000; padding: 15px; margin-bottom: 20px; }
            .sheet:last-child { page-break-after: auto; }
            h2 { font-size: 14pt; margin: 0 0 10px 0; border-bottom: 2px solid #000; padding-bottom: 5px; }
            .info { display: flex; justify-content: space-between; margin-bottom: 15px; }
            .info-left { }
            .info-right { text-align: right; }
            .grade-box { 
                font-size: 28pt; 
                font-weight: bold; 
                text-align: center; 
                padding: 10px 20px; 
                border: 3px solid #000; 
                display: inline-block;
                margin: 10px 0;
            }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 9pt; }
            th, td { border: 1px solid #999; padding: 5px 6px; text-align: left; vertical-align: top; }
            th { background: #f0f0f0; }
            .correct { background: #d4edda; }
            .partial { background: #fff3cd; }
            .incorrect { background: #f8d7da; }
            .bonus { background: #f3e5f5; }
            .answer-correct { color: #2e7d32; font-weight: bold; }
            .answer-wrong { color: #c62828; }
            .sig-line { margin-top: 30px; border-top: 1px solid #000; padding-top: 5px; font-size: 9pt; }
            @media print {
                .sheet { border: none; }
            }
        </style>
    </head>
    <body>`;
    
    results.forEach(r => {
        const gradeClass = r.grade >= 10 ? 'good' : (r.grade >= 5 ? 'ok' : 'bad');
        
        html += `<div class="sheet">
            <h2>üìê Feedback: Stundenleistung Bewegungslehre ‚Äì Klasse 10 GY</h2>
            <div class="info">
                <div class="info-left">
                    <p><strong>Platz:</strong> ${r.seatId}</p>
                    <p><strong>Bearbeitungszeit:</strong> ${formatDuration(r.duration)} von 90:00</p>
                    <p><strong>Datum:</strong> ${new Date().toLocaleDateString('de-DE')}</p>
                </div>
                <div class="info-right">
                    <div class="grade-box">${r.grade} NP</div>
                    <p><strong>${r.totalPoints} / ${MAX_POINTS} Punkte</strong> (${r.percentage.toFixed(1)}%)</p>
                    ${r.bonusPoints > 0 ? `<p>üéÑ Bonus: ${r.bonusPoints} / 3 P</p>` : ''}
                </div>
            </div>
            <table>
                <tr>
                    <th style="width:40px;">#</th>
                    <th style="width:25%;">Aufgabe</th>
                    <th style="width:25%;">Sch√ºlerantwort</th>
                    <th style="width:25%;">Musterl√∂sung</th>
                    <th style="width:60px;">Punkte</th>
                </tr>`;
        
        r.answers.forEach(a => {
            const q = QUESTIONS.find(qu => qu.id === a.q) || { id: a.q, text: a.q, points: 2 };
            const rowClass = a.c ? 'correct' : (a.p > 0 ? 'partial' : 'incorrect');
            const bonusClass = q.id === 'BONUS' ? ' bonus' : '';
            
            // Sch√ºlerantwort formatieren
            let studentAnswer = '‚Äì';
            if (a.a !== null && a.a !== undefined) {
                studentAnswer = formatAnswerForPrint(a.a);
            }
            
            // Musterl√∂sung formatieren
            let correctAnswer = '‚Äì';
            if (a.ca !== null && a.ca !== undefined) {
                correctAnswer = formatAnswerForPrint(a.ca);
            } else if (q.fullText) {
                correctAnswer = q.fullText;
            } else if (q.correct !== undefined) {
                correctAnswer = formatAnswerForPrint(q.correct);
            }
            
            const answerClass = a.c ? 'answer-correct' : 'answer-wrong';
            
            html += `<tr class="${rowClass}${bonusClass}">
                <td>${a.q}</td>
                <td>${q.text}</td>
                <td class="${answerClass}">${studentAnswer}</td>
                <td class="answer-correct">${correctAnswer}</td>
                <td>${a.p}/${q.points}</td>
            </tr>`;
        });
        
        html += `</table>
            <div class="sig-line">
                Unterschrift Lehrkraft: _________________________ Datum: _____________
            </div>
        </div>`;
    });
    
    html += '</body></html>';
    win.document.write(html);
    win.document.close();
}

// Hilfsfunktion zum Formatieren von Antworten f√ºr Druck
function formatAnswerForPrint(answer) {
    if (answer === null || answer === undefined) return '‚Äì';
    
    const letters = ['A', 'B', 'C', 'D'];
    
    if (typeof answer === 'object') {
        if (answer.value !== undefined) {
            return `${answer.value} ${answer.unit || ''}`;
        } else if (answer.value1 !== undefined) {
            return `${answer.value1}, ${answer.value2} ${answer.unit || ''}`;
        } else if (Array.isArray(answer)) {
            return answer.map((x, i) => x !== null && x !== undefined ? letters[x] || x : '‚Äì').join(', ');
        } else {
            // Fields object (multi-calc, mixed-analysis)
            const entries = Object.entries(answer);
            if (entries.length === 0) return '‚Äì';
            return entries.map(([k, v]) => {
                if (typeof v === 'object' && v !== null) {
                    if (v.value !== undefined) return `${k}: ${v.value} ${v.unit || ''}`;
                    if (v.value1 !== undefined) return `${k}: ${v.value1}`;
                    if (typeof v === 'number') return `${k}: ${letters[v] || v}`;
                }
                if (typeof v === 'number' && v < 4) return `${k}: ${letters[v]}`;
                return `${k}: ${v !== null ? v : '‚Äì'}`;
            }).join('<br>');
        }
    } else {
        if (typeof answer === 'number' && answer < 4) return letters[answer];
        return String(answer);
    }
}

function showError(msg) {
    const el = document.getElementById('errorMessage');
    el.textContent = msg;
    el.classList.add('visible');
}

function hideError() {
    document.getElementById('errorMessage').classList.remove('visible');
}

// =============================================================================
// INIT
// =============================================================================
document.addEventListener('DOMContentLoaded', async () => {
    // Kameras laden
    await initCameras();
    // Scanner standardm√§√üig starten
    startScanner();
});

// Cleanup beim Verlassen
window.addEventListener('beforeunload', () => {
    stopScanner();
});
</script>
</body>
</html>
