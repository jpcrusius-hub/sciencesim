<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Decoder ‚Äì Elektrizit√§tslehre Klasse 8</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: #333; }
        .section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .section h2 { margin-bottom: 15px; color: #1565c0; font-size: 1.2em; }
        #reader { width: 100%; max-width: 500px; margin: 0 auto; }
        .camera-select { margin-bottom: 15px; }
        .camera-select select { padding: 10px; font-size: 1em; border-radius: 6px; border: 1px solid #ddd; width: 100%; }
        textarea { width: 100%; height: 100px; padding: 10px; font-family: monospace; font-size: 0.85em; border: 2px solid #ddd; border-radius: 8px; resize: vertical; }
        .decode-btn { width: 100%; padding: 15px; font-size: 1.1em; font-weight: bold; border: none; border-radius: 8px; background: #4caf50; color: white; cursor: pointer; margin-top: 10px; }
        .decode-btn:hover { background: #45a049; }
        .result { margin-top: 20px; }
        .result-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 15px; }
        .result-header .grade { font-size: 2.5em; font-weight: bold; }
        .result-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .result-item { background: #f5f5f5; padding: 15px; border-radius: 8px; }
        .result-item label { font-size: 0.85em; color: #666; display: block; margin-bottom: 5px; }
        .result-item .value { font-size: 1.2em; font-weight: bold; color: #333; }
        .answers-section { margin-top: 20px; }
        .answer-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .answer-row:nth-child(odd) { background: #fafafa; }
        .export-btn { display: block; width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 8px; background: #ff9800; color: white; font-weight: bold; cursor: pointer; }
        .error { background: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 15px; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîì Quiz Decoder</h1>
        <p style="text-align: center; color: #666; margin-bottom: 20px;">Elektrizit√§tslehre Klasse 8 ‚Äì Lehrer-Auswertung</p>
        
        <div class="section">
            <h2>üì∑ QR-Code scannen</h2>
            <div class="camera-select">
                <select id="cameraSelect"><option value="">Kamera w√§hlen...</option></select>
            </div>
            <div id="reader"></div>
        </div>
        
        <div class="section">
            <h2>üìù Oder Code manuell eingeben</h2>
            <textarea id="codeInput" placeholder="Code hier einf√ºgen..."></textarea>
            <button class="decode-btn" onclick="decodeManual()">Dekodieren</button>
        </div>
        
        <div id="resultSection" class="section result" style="display: none;">
            <h2>üìä Ergebnis</h2>
            <div class="result-header">
                <div>Stundenleistung Elektrizit√§tslehre</div>
                <div class="grade" id="resultGrade">-- NP</div>
                <div id="resultPoints">-- / -- Punkte</div>
            </div>
            <div class="result-grid">
                <div class="result-item"><label>Niveau</label><div class="value" id="resultNiveau">--</div></div>
                <div class="result-item"><label>Sitzplatz</label><div class="value" id="resultSeat">--</div></div>
                <div class="result-item"><label>Zeit</label><div class="value" id="resultTime">--</div></div>
                <div class="result-item"><label>Prozent</label><div class="value" id="resultPercent">--%</div></div>
            </div>
            <div class="answers-section" id="answersSection"></div>
            <button class="export-btn" onclick="exportCSV()">üì• Als CSV exportieren</button>
        </div>
        
        <div id="errorSection" class="error" style="display: none;"></div>
    </div>
    
    <script>
        const CONFIG = {
            LEVELS: {
                'basis': { name: 'Basis', symbol: '‚óã', totalPoints: 28 },
                'stern1': { name: 'Stern 1', symbol: '‚òÖ', totalPoints: 30 },
                'stern2': { name: 'Stern 2', symbol: '‚òÖ‚òÖ', totalPoints: 30 },
                'stern3': { name: 'Stern 3', symbol: '‚òÖ‚òÖ‚òÖ', totalPoints: 52 }
            },
            GRADE_SCALE: [
                { np: 14, pct: 100 }, { np: 13, pct: 96 }, { np: 12, pct: 90.67 },
                { np: 11, pct: 86 }, { np: 10, pct: 80 }, { np: 9, pct: 73.33 },
                { np: 8, pct: 66.67 }, { np: 7, pct: 60 }, { np: 6, pct: 53.33 },
                { np: 5, pct: 46.67 }, { np: 4, pct: 40 }, { np: 3, pct: 33.33 },
                { np: 2, pct: 26.67 }, { np: 1, pct: 20 }, { np: 0, pct: 0 }
            ]
        };
        
        let currentResult = null;
        let html5QrCode = null;
        
        async function initCameras() {
            try {
                const devices = await Html5Qrcode.getCameras();
                const select = document.getElementById('cameraSelect');
                select.innerHTML = '<option value="">Kamera w√§hlen...</option>';
                devices.forEach((device, i) => {
                    const option = document.createElement('option');
                    option.value = device.id;
                    option.textContent = device.label || `Kamera ${i + 1}`;
                    select.appendChild(option);
                });
                
                select.addEventListener('change', () => {
                    if (select.value) startScanner(select.value);
                });
                
                if (devices.length > 0) {
                    select.value = devices[devices.length - 1].id;
                    startScanner(devices[devices.length - 1].id);
                }
            } catch (err) {
                console.error('Kamera-Fehler:', err);
            }
        }
        
        function startScanner(cameraId) {
            if (html5QrCode) {
                html5QrCode.stop().catch(() => {});
            }
            
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                cameraId,
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    decodeResult(decodedText);
                    html5QrCode.stop();
                },
                () => {}
            ).catch(err => console.error('Scanner-Fehler:', err));
        }
        
        function decodeManual() {
            const code = document.getElementById('codeInput').value.trim();
            if (code) decodeResult(code);
        }
        
        function decodeResult(code) {
            try {
                let data;
                try {
                    data = JSON.parse(LZString.decompressFromEncodedURIComponent(code));
                } catch {
                    data = JSON.parse(atob(code));
                }
                
                currentResult = data;
                displayResult(data);
                document.getElementById('errorSection').style.display = 'none';
            } catch (err) {
                document.getElementById('errorSection').textContent = 'Fehler beim Dekodieren: ' + err.message;
                document.getElementById('errorSection').style.display = 'block';
                document.getElementById('resultSection').style.display = 'none';
            }
        }
        
        function displayResult(data) {
            const level = CONFIG.LEVELS[data.n] || { name: data.n, totalPoints: data.m };
            const percent = Math.round((data.p / data.m) * 1000) / 10;
            const grade = calculateGrade(percent);
            
            document.getElementById('resultGrade').textContent = `${grade} NP`;
            document.getElementById('resultPoints').textContent = `${data.p} / ${data.m} Punkte`;
            document.getElementById('resultNiveau').textContent = `${level.symbol || ''} ${level.name}`;
            document.getElementById('resultSeat').textContent = data.s || '--';
            document.getElementById('resultTime').textContent = formatTime(data.t);
            document.getElementById('resultPercent').textContent = `${percent}%`;
            
            // Answers
            let answersHtml = '<h3 style="margin: 15px 0;">Antworten</h3>';
            if (data.a) {
                Object.entries(data.a).forEach(([qid, answer]) => {
                    let ansStr = typeof answer === 'object' ? JSON.stringify(answer) : answer;
                    answersHtml += `<div class="answer-row"><span>${qid}</span><span>${ansStr}</span></div>`;
                });
            }
            document.getElementById('answersSection').innerHTML = answersHtml;
            document.getElementById('resultSection').style.display = 'block';
        }
        
        function calculateGrade(percent) {
            for (const g of CONFIG.GRADE_SCALE) {
                if (percent >= g.pct) return g.np;
            }
            return 0;
        }
        
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
        
        function exportCSV() {
            if (!currentResult) return;
            const data = currentResult;
            const level = CONFIG.LEVELS[data.n] || { name: data.n };
            const percent = Math.round((data.p / data.m) * 1000) / 10;
            const grade = calculateGrade(percent);
            
            let csv = 'Feld,Wert\n';
            csv += `Niveau,${level.name}\n`;
            csv += `Sitzplatz,${data.s}\n`;
            csv += `Punkte,${data.p}\n`;
            csv += `Maximum,${data.m}\n`;
            csv += `Prozent,${percent}\n`;
            csv += `Note,${grade}\n`;
            csv += `Zeit (Sek),${data.t}\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `quiz_${data.s}_${data.n}.csv`;
            a.click();
        }
        
        document.addEventListener('DOMContentLoaded', initCameras);
    </script>
</body>
</html>
