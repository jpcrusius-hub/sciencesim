<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wellenrefraktion – Stufenmodell</title>
    <meta name="subject" content="Physik">
    <meta name="topic" content="Wellen">
    <meta name="grade" content="9-12">
    <meta name="description" content="Simulation zur Brechung von Wasserwellen an diskreten Tiefenstufen">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #222;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 15px;
        }

        .breadcrumb {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .breadcrumb a {
            color: #2c5aa0;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        h1 {
            font-size: 1.4em;
            font-weight: 600;
            color: #222;
        }

        .subtitle {
            font-size: 0.9em;
            color: #555;
            margin-top: 3px;
        }

        .canvas-container {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
        }

        .canvas-container canvas {
            display: block;
            width: 100%;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (max-width: 800px) {
            .controls-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 500px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #fff;
            border: 1px solid #ddd;
            padding: 12px;
        }

        .card h3 {
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            color: #333;
        }

        .slider-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .slider-label {
            min-width: 95px;
            font-size: 0.8em;
            color: #555;
        }

        input[type="range"] {
            flex: 1;
            height: 4px;
            -webkit-appearance: none;
            background: #ddd;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #2c5aa0;
            cursor: pointer;
        }

        .slider-value {
            min-width: 36px;
            text-align: right;
            font-size: 0.8em;
            font-weight: 500;
            color: #2c5aa0;
        }

        .depth-row {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 5px;
        }

        .depth-row input[type="number"] {
            width: 55px;
            padding: 4px 6px;
            border: 1px solid #ccc;
            background: #fff;
            color: #222;
            font-size: 0.8em;
            font-weight: 500;
            text-align: right;
        }

        .depth-row input[type="number"]:focus {
            outline: none;
            border-color: #2c5aa0;
        }

        .depth-unit {
            font-size: 0.75em;
            color: #666;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 8px;
            font-size: 0.8em;
            cursor: pointer;
        }

        .checkbox-row input {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: #2c5aa0;
        }

        .color-dot {
            width: 10px;
            height: 10px;
            display: inline-block;
            margin-left: 4px;
            border: 1px solid #ccc;
        }

        .dot-red { background: #cc4444; }
        .dot-yellow { background: #cc9900; }
        .dot-green { background: #339933; }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        button {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            background: #fff;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
        }

        button:hover {
            background: #f5f5f5;
        }

        button.active {
            background: #2c5aa0;
            color: #fff;
            border-color: #2c5aa0;
        }

        .info-box {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-box h3 {
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .formula {
            background: #f5f5f5;
            padding: 10px;
            text-align: center;
            font-family: "Times New Roman", serif;
            font-size: 1.1em;
            margin: 8px 0;
            border-left: 3px solid #2c5aa0;
        }

        .info-box p {
            font-size: 0.9em;
            color: #555;
            line-height: 1.5;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85em;
        }

        .leg-box {
            width: 16px;
            height: 10px;
            border: 1px solid #ccc;
        }

        .material-box {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 15px;
        }

        .material-box h3 {
            font-size: 0.95em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .material-list {
            list-style: none;
        }

        .material-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        .material-list li:last-child {
            border-bottom: none;
        }

        .material-list a {
            color: #2c5aa0;
            text-decoration: none;
        }

        footer {
            text-align: center;
            padding: 15px;
            font-size: 0.8em;
            color: #888;
            border-top: 1px solid #ddd;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <p class="breadcrumb"><a href="../../../">Uebersicht</a> · Physik · Wellen</p>
            <h1>Wellenrefraktion – Stufenmodell</h1>
            <p class="subtitle">Kontinuierliche Brechung an diskreten Tiefenstufen</p>
        </header>

        <div class="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="controls-grid">
            <div class="card">
                <h3>Simulation</h3>
                <div class="slider-row">
                    <span class="slider-label">Einfallswinkel:</span>
                    <input type="range" id="sliderAngle" min="5" max="70" value="45">
                    <span class="slider-value" id="valAngle">45°</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label">Anzahl Stufen:</span>
                    <input type="range" id="sliderSteps" min="2" max="40" value="5">
                    <span class="slider-value" id="valSteps">5</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label">Wellenabstand:</span>
                    <input type="range" id="sliderSpacing" min="40" max="200" value="90">
                    <span class="slider-value" id="valSpacing">90</span>
                </div>
                <div class="slider-row">
                    <span class="slider-label">Geschwindigkeit:</span>
                    <input type="range" id="sliderSpeed" min="5" max="80" value="30">
                    <span class="slider-value" id="valSpeed">30%</span>
                </div>
                <div class="depth-row">
                    <span class="slider-label">Tiefe:</span>
                    <input type="number" id="inputHmax" value="10" min="0.1" max="100" step="0.1">
                    <span class="depth-unit">m →</span>
                    <input type="number" id="inputHmin" value="0.1" min="0.01" max="10" step="0.01">
                    <span class="depth-unit">m</span>
                </div>
                <div class="btn-row">
                    <button class="active" id="btnPlay">Pause</button>
                    <button id="btnReset">Reset</button>
                </div>
            </div>

            <div class="card">
                <h3>Anzeige-Optionen</h3>
                <label class="checkbox-row">
                    <input type="checkbox" id="chkNormals">
                    Wellennormalen <span class="color-dot dot-red"></span>
                </label>
                <label class="checkbox-row">
                    <input type="checkbox" id="chkAngles">
                    Winkel anzeigen <span class="color-dot dot-yellow"></span>
                </label>
                <label class="checkbox-row">
                    <input type="checkbox" id="chkSpeed">
                    Geschwindigkeiten <span class="color-dot dot-green"></span>
                </label>
                <label class="checkbox-row">
                    <input type="checkbox" id="chkDepth" checked>
                    Tiefenwerte anzeigen
                </label>
                <label class="checkbox-row">
                    <input type="checkbox" id="chkRays">
                    Strahlengang (Lichtstrahl)
                </label>
                <label class="checkbox-row">
                    <input type="checkbox" id="chkBoundaries" checked>
                    Stufengrenzen zeigen
                </label>
            </div>

            <div class="card">
                <h3>Physik</h3>
                <div class="formula">
                    sin(θ₁) / sin(θ₂) = v₁ / v₂
                </div>
                <div class="formula">
                    v = √(g · h)
                </div>
                <p style="font-size:0.8em; color:#555; margin-top:8px;">
                    Flacher → langsamer → Brechung zum Lot
                </p>
                <div class="legend">
                    <div class="legend-item"><span class="leg-box" style="background:#0a2463"></span>Tief</div>
                    <div class="legend-item"><span class="leg-box" style="background:#3a9fbf"></span>Mittel</div>
                    <div class="legend-item"><span class="leg-box" style="background:#7ec8e3"></span>Flach</div>
                    <div class="legend-item"><span class="leg-box" style="background:#f4d03f"></span>Strand</div>
                </div>
            </div>
        </div>

        <div class="material-box">
            <h3>Materialien</h3>
            <ul class="material-list">
                <li><a href="arbeitsblatt-anleitung.html">Anleitung zur Simulation</a> – Bedienung und Hintergrund</li>
            </ul>
        </div>

        <footer>
            Wellenrefraktion – Stufenmodell · Physik Sekundarstufe
        </footer>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let W, H;
        function resize() {
            const rect = canvas.parentElement.getBoundingClientRect();
            W = rect.width - 20;
            H = Math.min(W * 0.5, 400);
            canvas.width = W;
            canvas.height = H;
            canvas.style.height = H + 'px';
        }
        resize();
        window.addEventListener('resize', resize);
        
        // === PARAMETER ===
        let incidentAngle = 45;
        let numSteps = 5;
        let waveSpacing = 90;
        let speed = 30;
        let paused = false;
        let animPhase = 0;
        let hMax = 10;    // Maximale Tiefe in Metern
        let hMin = 0.1;   // Minimale Tiefe in Metern
        
        let showNormals = false;
        let showAngles = false;
        let showSpeed = false;
        let showDepth = true;
        let showRays = false;
        let showBoundaries = true;
        
        // === UI ===
        document.getElementById('sliderAngle').oninput = function() {
            incidentAngle = +this.value;
            document.getElementById('valAngle').textContent = incidentAngle + '°';
        };
        
        document.getElementById('sliderSteps').oninput = function() {
            numSteps = +this.value;
            document.getElementById('valSteps').textContent = numSteps;
        };
        
        document.getElementById('sliderSpacing').oninput = function() {
            waveSpacing = +this.value;
            document.getElementById('valSpacing').textContent = waveSpacing;
        };
        
        document.getElementById('sliderSpeed').oninput = function() {
            speed = +this.value;
            document.getElementById('valSpeed').textContent = speed + '%';
        };
        
        document.getElementById('inputHmax').oninput = function() {
            const val = parseFloat(this.value);
            if (!isNaN(val) && val > 0) {
                hMax = Math.max(0.1, val);
                if (hMax <= hMin) {
                    hMax = hMin + 0.1;
                    this.value = hMax;
                }
            }
        };
        
        document.getElementById('inputHmin').oninput = function() {
            const val = parseFloat(this.value);
            if (!isNaN(val) && val > 0) {
                hMin = Math.max(0.01, val);
                if (hMin >= hMax) {
                    hMin = hMax - 0.01;
                    this.value = hMin;
                }
            }
        };
        
        document.getElementById('btnPlay').onclick = function() {
            paused = !paused;
            this.textContent = paused ? 'Start' : 'Pause';
            this.classList.toggle('active', !paused);
        };
        
        document.getElementById('btnReset').onclick = function() {
            incidentAngle = 45; numSteps = 5; waveSpacing = 90; speed = 30;
            paused = false; animPhase = 0;
            hMax = 10; hMin = 0.1;
            document.getElementById('sliderAngle').value = 45;
            document.getElementById('sliderSteps').value = 5;
            document.getElementById('sliderSpacing').value = 90;
            document.getElementById('sliderSpeed').value = 30;
            document.getElementById('inputHmax').value = 10;
            document.getElementById('inputHmin').value = 0.1;
            document.getElementById('valAngle').textContent = '45°';
            document.getElementById('valSteps').textContent = '5';
            document.getElementById('valSpacing').textContent = '90';
            document.getElementById('valSpeed').textContent = '30%';
            document.getElementById('btnPlay').textContent = 'Pause';
            document.getElementById('btnPlay').classList.add('active');
        };
        
        document.getElementById('chkNormals').onchange = function() { showNormals = this.checked; };
        document.getElementById('chkAngles').onchange = function() { showAngles = this.checked; };
        document.getElementById('chkSpeed').onchange = function() { showSpeed = this.checked; };
        document.getElementById('chkDepth').onchange = function() { showDepth = this.checked; };
        document.getElementById('chkRays').onchange = function() { showRays = this.checked; };
        document.getElementById('chkBoundaries').onchange = function() { showBoundaries = this.checked; };
        
        // === STUFEN BERECHNEN ===
        function getSteps() {
            const steps = [];
            const waterHeight = H * 0.88;
            const stepHeight = waterHeight / numSteps;
            
            const depthRatio = hMin / hMax;
            
            for (let i = 0; i < numSteps; i++) {
                const yStart = i * stepHeight;
                const yEnd = (i + 1) * stepHeight;
                
                const t = i / (numSteps - 1 || 1);
                const depthFactor = Math.pow(depthRatio, t);
                const waveSpeed = Math.sqrt(depthFactor);
                const depthM = depthFactor * hMax;
                
                steps.push({
                    yStart: yStart,
                    yEnd: yEnd,
                    yMid: (yStart + yEnd) / 2,
                    height: stepHeight,
                    depth: depthFactor,
                    depthM: depthM,
                    speed: waveSpeed,
                    angle: 0
                });
            }
            
            steps[0].angle = incidentAngle * Math.PI / 180;
            
            for (let i = 1; i < steps.length; i++) {
                const prev = steps[i - 1];
                const curr = steps[i];
                const sinTheta2 = Math.sin(prev.angle) * (curr.speed / prev.speed);
                
                if (Math.abs(sinTheta2) >= 0.999) {
                    curr.angle = prev.angle * 0.95;
                } else {
                    curr.angle = Math.asin(sinTheta2);
                }
            }
            
            return steps;
        }
        
        // === FARBEN ===
        function getStepColor(depthFactor) {
            const depthRatio = hMin / hMax;
            const logD = Math.log10(Math.max(depthRatio, depthFactor));
            const logMin = Math.log10(depthRatio);
            const colorT = Math.min(1, Math.max(0, logD / logMin));
            
            const colors = [
                [10, 36, 99],
                [30, 95, 138],
                [58, 159, 191],
                [126, 200, 227]
            ];
            
            const idx = Math.min(2, Math.floor(colorT * 3));
            const localT = (colorT * 3) - idx;
            
            return lerpColor(colors[idx], colors[idx + 1], localT);
        }
        
        function lerpColor(a, b, t) {
            const r = Math.round(a[0] + (b[0] - a[0]) * t);
            const g = Math.round(a[1] + (b[1] - a[1]) * t);
            const bl = Math.round(a[2] + (b[2] - a[2]) * t);
            return `rgb(${r},${g},${bl})`;
        }
        
        // === ZEICHNEN ===
        
        function drawBackground(steps) {
            for (let i = 0; i < steps.length; i++) {
                const s = steps[i];
                ctx.fillStyle = getStepColor(s.depth);
                ctx.fillRect(0, s.yStart, W, s.height + 1);
                
                if (showBoundaries && i > 0) {
                    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([6, 6]);
                    ctx.beginPath();
                    ctx.moveTo(0, s.yStart);
                    ctx.lineTo(W, s.yStart);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }
            
            const sandY = H * 0.88;
            const grd = ctx.createLinearGradient(0, sandY, 0, H);
            grd.addColorStop(0, '#c9a227');
            grd.addColorStop(1, '#f4d03f');
            ctx.fillStyle = grd;
            ctx.fillRect(0, sandY, W, H - sandY);
            
            ctx.strokeStyle = 'rgba(255,255,255,0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, sandY);
            ctx.lineTo(W, sandY);
            ctx.stroke();
        }
        
        function drawAnnotations(steps) {
            const showDetailed = numSteps <= 10;
            
            ctx.textAlign = 'right';
            ctx.font = '10px sans-serif';
            
            for (let i = 0; i < steps.length; i++) {
                const s = steps[i];
                if (!showDetailed && i % Math.ceil(numSteps / 6) !== 0 && i !== steps.length - 1) continue;
                
                const y = s.yMid;
                
                if (showDepth) {
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    const dm = s.depthM;
                    let label;
                    if (dm >= 1) {
                        label = 'h=' + dm.toFixed(1) + 'm';
                    } else if (dm >= 0.1) {
                        label = 'h=' + (dm * 100).toFixed(0) + 'cm';
                    } else {
                        label = 'h=' + (dm * 100).toFixed(1) + 'cm';
                    }
                    ctx.fillText(label, W - 10, y - 5);
                }
                
                if (showSpeed) {
                    ctx.fillStyle = '#26de81';
                    ctx.fillText('v=' + s.speed.toFixed(2) + 'v₀', W - 10, y + 9);
                }
            }
            
            ctx.textAlign = 'left';
            ctx.font = '10px sans-serif';
            
            if (showAngles) {
                ctx.fillStyle = '#f9ca24';
                ctx.fillText('θ₀ = ' + incidentAngle + '°', 8, 14);
                
                const finalAngle = (steps[steps.length - 1].angle * 180 / Math.PI).toFixed(1);
                ctx.fillText('θ_end = ' + finalAngle + '°', 8, H * 0.88 - 8);
            }
        }
        
        // === WELLENKAMM (KONTINUIERLICH!) ===
        function drawWaveCrest(startX, steps) {
            const points = [];
            
            let x = startX;
            let y = 0;
            
            points.push({ x: x, y: y, angle: steps[0].angle });
            
            for (let i = 0; i < steps.length; i++) {
                const s = steps[i];
                const theta = s.angle;
                const cotTheta = Math.cos(theta) / Math.sin(theta);
                
                const yEnd = s.yEnd;
                const deltaY = yEnd - y;
                
                x = x - cotTheta * deltaY;
                y = yEnd;
                
                points.push({ x: x, y: y, angle: theta, stepEnd: true });
            }
            
            ctx.beginPath();
            ctx.moveTo(points[0].x, points[0].y);
            
            for (let i = 1; i < points.length; i++) {
                ctx.lineTo(points[i].x, points[i].y);
            }
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.85)';
            ctx.lineWidth = 2.5;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 6;
            ctx.stroke();
            
            return points;
        }
        
        function drawNormals(steps) {
            if (!showNormals) return;
            
            const skipFactor = Math.max(1, Math.floor(numSteps / 8));
            
            for (let i = 0; i < steps.length; i += skipFactor) {
                const s = steps[i];
                const theta = s.angle;
                
                const x = W * 0.5;
                const y = s.yMid;
                
                const len = 25;
                const nx = Math.sin(theta) * len;
                const ny = Math.cos(theta) * len;
                
                ctx.strokeStyle = '#ff6b6b';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(x + nx, y + ny);
                ctx.stroke();
                
                const tipX = x + nx;
                const tipY = y + ny;
                ctx.fillStyle = '#ff6b6b';
                ctx.beginPath();
                ctx.moveTo(tipX, tipY);
                ctx.lineTo(tipX - 5 * Math.sin(theta + 0.5), tipY - 5 * Math.cos(theta + 0.5));
                ctx.lineTo(tipX - 5 * Math.sin(theta - 0.5), tipY - 5 * Math.cos(theta - 0.5));
                ctx.closePath();
                ctx.fill();
                
                if (showAngles && numSteps <= 10) {
                    ctx.fillStyle = '#f9ca24';
                    ctx.font = '9px sans-serif';
                    const angleDeg = (theta * 180 / Math.PI).toFixed(0);
                    ctx.fillText(angleDeg + '°', x + nx + 5, y + ny);
                }
            }
        }
        
        function drawRayPath(steps) {
            if (!showRays) return;
            
            let x = W * 0.3;
            let y = 0;
            
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 4]);
            ctx.beginPath();
            ctx.moveTo(x, y);
            
            for (let i = 0; i < steps.length; i++) {
                const s = steps[i];
                const theta = s.angle;
                const tanTheta = Math.tan(theta);
                const dx = tanTheta * s.height;
                
                x += dx;
                y = s.yEnd;
                
                ctx.lineTo(x, y);
            }
            
            ctx.stroke();
            ctx.setLineDash([]);
            
            if (numSteps <= 12) {
                for (let i = 1; i < steps.length; i++) {
                    const s = steps[i];
                    let rayX = W * 0.3;
                    for (let j = 0; j < i; j++) {
                        rayX += Math.tan(steps[j].angle) * steps[j].height;
                    }
                    
                    ctx.strokeStyle = 'rgba(255,255,255,0.4)';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([3, 3]);
                    ctx.beginPath();
                    ctx.moveTo(rayX, s.yStart - 20);
                    ctx.lineTo(rayX, s.yStart + 20);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }
        }
        
        function drawLegend() {
            if (!showNormals && !showRays && !showAngles) return;
            
            const boxW = 180;
            const boxH = 40;
            const x = 8;
            const y = H - boxH - 8;
            
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.fillRect(x, y, boxW, boxH);
            
            ctx.font = '9px sans-serif';
            ctx.fillStyle = 'white';
            ctx.fillText('Legende:', x + 5, y + 12);
            
            let ly = y + 25;
            if (showNormals || showRays) {
                ctx.fillStyle = '#ff6b6b';
                ctx.fillText('→ Ausbreitungsrichtung', x + 5, ly);
                ly += 11;
            }
            if (showAngles) {
                ctx.fillStyle = '#f9ca24';
                ctx.fillText('θ Winkel zum Lot', x + 5, ly);
            }
        }
        
        // === HAUPTFUNKTION ===
        function draw() {
            ctx.clearRect(0, 0, W, H);
            
            const steps = getSteps();
            
            drawBackground(steps);
            
            let totalDrift = 0;
            let y = 0;
            for (let i = 0; i < steps.length; i++) {
                const s = steps[i];
                const theta = s.angle;
                if (theta > 0.01) {
                    const cotTheta = Math.cos(theta) / Math.sin(theta);
                    const deltaY = s.yEnd - y;
                    totalDrift += cotTheta * deltaY;
                }
                y = s.yEnd;
            }
            
            const rightMargin = Math.max(W, totalDrift + W);
            const numWavesRight = Math.ceil(rightMargin / waveSpacing);
            const numWavesLeft = 6;
            
            for (let i = -numWavesLeft; i < numWavesRight; i++) {
                const baseX = i * waveSpacing + animPhase;
                drawWaveCrest(baseX, steps);
            }
            
            drawNormals(steps);
            drawRayPath(steps);
            drawAnnotations(steps);
            drawLegend();
        }
        
        // === ANIMATION ===
        let lastTime = 0;
        
        function animate(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const dt = timestamp - lastTime;
            lastTime = timestamp;
            
            if (!paused) {
                animPhase += dt * speed * 0.003;
                
                while (animPhase >= waveSpacing) {
                    animPhase -= waveSpacing;
                }
            }
            
            draw();
            requestAnimationFrame(animate);
        }
        
        requestAnimationFrame(animate);
    </script>
</body>
</html>
